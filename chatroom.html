
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ¿åèŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .chat-container {
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }

        .admin-badge.show {
            display: block;
        }

        .online-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .ip-display {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .connection-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.3);
        }

        .connection-status.connecting {
            background: rgba(241, 196, 15, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.3);
        }

        .chat-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
            word-wrap: break-word;
        }

        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.other {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .message.system {
            align-self: center;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-style: italic;
            font-size: 0.9rem;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .username {
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .username:hover {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .admin-info {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-left: 10px;
            display: none;
        }

        .admin-info.show {
            display: inline-block;
        }

        .timestamp {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .sidebar.show {
            display: block;
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-item.current-user {
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .user-details {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .user-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .user-status.offline {
            background: #e74c3c;
        }

        .chat-input {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .message-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn, .admin-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .send-btn:hover, .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .send-btn:disabled, .admin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .admin-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid #667eea;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .user-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-detail-item {
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .user-detail-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .user-detail-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .user-detail-value {
            color: #666;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .kick-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        .kick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .admin-config {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #ff8c00;
        }

        .admin-config strong {
            color: #d2691e;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å…¨çƒæ‰‹æœºè®¾å¤‡å®Œç¾è‡ªé€‚åº”æ ·å¼ */

        /* åŸºç¡€ç§»åŠ¨ç«¯é€‚é… - åŒ…å«æ‰€æœ‰æ‰‹æœº */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }

            .chat-container {
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ */
                border-radius: 0;
                max-width: none;
                position: fixed;
                top: 0;
                left: 0;
            }

            .chat-header {
                padding: env(safe-area-inset-top, 10px) 15px 10px 15px;
                flex-wrap: wrap;
                gap: 8px;
                min-height: 60px;
            }

            .chat-title {
                font-size: clamp(1rem, 4vw, 1.3rem);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .user-info {
                flex-wrap: wrap;
                gap: 6px;
                font-size: clamp(0.7rem, 2.5vw, 0.85rem);
                width: 100%;
                justify-content: space-between;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 4px 8px;
                font-size: clamp(0.65rem, 2vw, 0.75rem);
                border-radius: 12px;
                white-space: nowrap;
            }

            .chat-main {
                height: calc(100vh - 140px);
                height: calc(100dvh - 140px);
            }

            .chat-messages {
                padding: 10px;
                gap: 8px;
                height: 100%;
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }

            .message {
                max-width: 85%;
                padding: 10px 14px;
                font-size: clamp(0.85rem, 3.5vw, 1rem);
                border-radius: 16px;
                word-break: break-word;
                hyphens: auto;
            }

            .message-header {
                font-size: clamp(0.7rem, 2.8vw, 0.8rem);
                margin-bottom: 4px;
            }

            .timestamp {
                font-size: clamp(0.6rem, 2.2vw, 0.7rem);
            }

            .sidebar {
                width: 100vw;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                height: 100dvh;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
                padding: env(safe-area-inset-top, 20px) 15px env(safe-area-inset-bottom, 20px) 15px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar h3 {
                font-size: clamp(1rem, 4vw, 1.2rem);
                margin-bottom: 15px;
                color: white;
            }

            .user-item {
                padding: 12px;
                font-size: clamp(0.8rem, 3.2vw, 0.9rem);
                margin-bottom: 8px;
                min-height: 48px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .chat-input {
                padding: 10px 15px env(safe-area-inset-bottom, 10px) 15px;
                background: rgba(255, 255, 255, 0.1);
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            .input-container {
                gap: 8px;
                flex-wrap: nowrap;
                align-items: stretch;
            }

            .message-input {
                flex: 1;
                min-width: 0;
                padding: 12px 16px;
                font-size: clamp(0.9rem, 3.8vw, 1rem);
                border-radius: 20px;
                border: none;
                outline: none;
                min-height: 44px;
            }

            .send-btn, .admin-btn {
                padding: 12px 16px;
                font-size: clamp(0.8rem, 3.2vw, 0.9rem);
                min-width: 80px;
                min-height: 44px;
                border-radius: 20px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .modal {
                z-index: 2000;
            }

            .modal-content {
                width: calc(100vw - 20px);
                max-width: none;
                margin: 10px;
                padding: 20px;
                max-height: calc(100vh - 40px);
                max-height: calc(100dvh - 40px);
                border-radius: 15px;
            }

            .user-detail-section {
                margin-bottom: 15px;
                padding: 12px;
            }

            .section-title {
                font-size: clamp(0.9rem, 3.5vw, 1rem);
            }

            .user-detail-item {
                margin-bottom: 10px;
                padding: 10px;
            }

            .user-detail-label {
                font-size: clamp(0.75rem, 3vw, 0.85rem);
            }

            .user-detail-value {
                font-size: clamp(0.7rem, 2.8vw, 0.8rem);
                padding: 6px;
            }
        }

        /* è¶…å°å±å¹•é€‚é… (å°äº480px) */
        @media screen and (max-width: 480px) {
            .chat-header {
                padding: env(safe-area-inset-top, 8px) 10px 8px 10px;
                min-height: 55px;
            }

            .chat-title {
                font-size: clamp(0.9rem, 4.5vw, 1.1rem);
            }

            .user-info {
                font-size: clamp(0.65rem, 2.8vw, 0.75rem);
                gap: 4px;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 3px 6px;
                font-size: clamp(0.6rem, 2.2vw, 0.7rem);
            }

            .chat-messages {
                padding: 8px;
                gap: 6px;
            }

            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: clamp(0.8rem, 3.8vw, 0.95rem);
            }

            .input-container {
                flex-direction: column;
                gap: 6px;
            }

            .message-input {
                width: 100%;
                margin-bottom: 0;
                min-height: 42px;
            }

            .send-btn, .admin-btn {
                width: 100%;
                margin-bottom: 0;
                min-height: 42px;
            }
        }

        /* è¶…å¤§å±æ‰‹æœºé€‚é… (iPhone Pro Max, å¤§å±Androidç­‰) */
        @media screen and (min-width: 414px) and (max-width: 768px) {
            .message {
                max-width: 80%;
                font-size: clamp(0.9rem, 3vw, 1.1rem);
            }

            .chat-header {
                min-height: 65px;
            }

            .user-info {
                font-size: clamp(0.8rem, 2.2vw, 0.9rem);
            }
        }

        /* æ¨ªå±æ‰‹æœºé€‚é… - è¦†ç›–æ‰€æœ‰æ¨ªå±æƒ…å†µ */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .chat-container {
                height: 100vh;
                height: 100dvh;
            }

            .chat-header {
                padding: 5px 15px;
                min-height: 45px;
            }

            .chat-title {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
            }

            .user-info {
                font-size: clamp(0.7rem, 2vw, 0.8rem);
                gap: 4px;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 2px 6px;
                font-size: clamp(0.6rem, 1.8vw, 0.7rem);
            }

            .chat-main {
                height: calc(100vh - 100px);
                height: calc(100dvh - 100px);
            }

            .chat-messages {
                padding: 6px 15px;
            }

            .chat-input {
                padding: 6px 15px;
            }

            .message-input {
                padding: 8px 12px;
                min-height: 36px;
            }

            .send-btn, .admin-btn {
                padding: 8px 12px;
                min-height: 36px;
                font-size: clamp(0.75rem, 2.5vw, 0.85rem);
            }
        }

        /* ç‰¹æ®Šå±å¹•æ¯”ä¾‹é€‚é… (21:9, 18:9ç­‰) */
        @media screen and (min-aspect-ratio: 2/1) {
            .chat-header {
                padding: 8px 20px;
            }

            .sidebar {
                width: 50vw;
                max-width: 400px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– - ç¡®ä¿æ‰€æœ‰è§¦æ‘¸å…ƒç´ è¶³å¤Ÿå¤§ */
        @media (hover: none) and (pointer: coarse) {
            .user-item {
                min-height: 48px;
                display: flex;
                align-items: center;
                padding: 12px;
                touch-action: manipulation;
            }

            .send-btn, .admin-btn {
                min-height: 48px;
                min-width: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .message-input {
                min-height: 48px;
                touch-action: manipulation;
            }

            .username {
                min-height: 28px;
                display: inline-block;
                line-height: 28px;
                touch-action: manipulation;
            }

            .close-btn {
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            .user-item::before {
                content: '';
                position: absolute;
                top: -5px;
                left: -5px;
                right: -5px;
                bottom: -5px;
                z-index: -1;
            }
        }

        /* é«˜DPIå±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .message {
                border: 0.5px solid rgba(255, 255, 255, 0.1);
            }

            .chat-container {
                border: 0.5px solid rgba(255, 255, 255, 0.2);
            }
        }

        /* æ— éšœç¢é€‚é… - æ”¯æŒç³»ç»Ÿå­—ä½“å¤§å°è®¾ç½® */
        @media (prefers-reduced-motion: reduce) {
            .sidebar {
                transition: none;
            }

            .message {
                animation: none;
            }

            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item:active {
            background-color: #e0e0e0;
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10001;
            font-size: 14px;
            animation: copyNotification 3s ease-in-out;
        }

        @keyframes copyNotification {
            0% { opacity: 0; transform: translateX(100%); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }

        /* ç³»ç»Ÿæ·±è‰²æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            .message.other {
                background: rgba(40, 40, 40, 0.9);
                color: #e0e0e0;
            }

            .modal-content {
                background: #2a2a2a;
                color: #e0e0e0;
            }

            .context-menu {
                background: #2a2a2a;
                border-color: #444;
            }

            .context-menu-item {
                color: #e0e0e0;
            }

            .context-menu-item:hover {
                background-color: #404040;
            }
        }

        /* é˜²æ­¢ç¼©æ”¾çš„é¢å¤–ä¿æŠ¤ */
        @media screen {
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
                touch-action: pan-x pan-y;
            }

            body {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                overscroll-behavior: none;
            }

            .message-input {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">åŒ¿åèŠå¤©å®¤</div>
            <div class="user-info">
                <span class="admin-badge" id="adminBadge">ç®¡ç†å‘˜</span>
                <span class="ip-display" id="ipDisplay">IP: è·å–ä¸­...</span>
                <span class="online-count">åœ¨çº¿: <span id="onlineCount">0</span></span>
                <span class="connection-status disconnected" id="connectionStatus">æœªè¿æ¥</span>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="loading">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>

            <div class="sidebar" id="sidebar">
                <h3>åœ¨çº¿ç”¨æˆ·ç®¡ç†</h3>
                <ul class="user-list" id="userList"></ul>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500" disabled>
                <button class="send-btn" id="sendBtn" disabled>å‘é€</button>
                <button class="admin-btn" id="adminBtn">ç®¡ç†é¢æ¿</button>
            </div>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="userDetails"></div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" id="copyMessage">ğŸ“‹ å¤åˆ¶æ¶ˆæ¯</button>
        <button class="context-menu-item" id="copyUsername">ğŸ‘¤ å¤åˆ¶ç”¨æˆ·å</button>
        <button class="context-menu-item" id="copyTime">ğŸ•’ å¤åˆ¶æ—¶é—´</button>
    </div>

    <script>
        class ChatClient {
            constructor() {
                this.ws = null;
                this.currentUser = null;
                this.users = new Map();
                this.isAdmin = false;
                this.roomId = 'default-room';
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.sidebarVisible = false;
                this.realIP = null;
                this.detectedIPs = [];

                this.initElements();
                this.detectAllIPs();
                this.connect();
                this.bindEvents();
            }

            async detectAllIPs() {
                this.detectedIPs = [];

                // æ£€æµ‹å¤–ç½‘IP
                try {
                    const ipServices = [
                        { url: 'https://api.ipify.org?format=json', key: 'ip' },
                        { url: 'https://httpbin.org/ip', key: 'origin' },
                        { url: 'https://api.ip.sb/ip', key: null },
                        { url: 'https://ipapi.co/ip/', key: null }
                    ];

                    for (const service of ipServices) {
                        try {
                            const response = await fetch(service.url);
                            let ip;

                            if (service.key) {
                                const data = await response.json();
                                ip = service.key === 'origin' ? data[service.key].split(',')[0].trim() : data[service.key];
                            } else {
                                ip = (await response.text()).trim();
                            }

                            if (ip && this.isValidIP(ip) && !this.detectedIPs.includes(ip)) {
                                this.detectedIPs.push(ip);
                            }
                        } catch (e) {
                            console.warn(`IPæœåŠ¡å¤±è´¥:`, e);
                        }
                    }
                } catch (error) {
                    console.error('å¤–ç½‘IPæ£€æµ‹å¤±è´¥:', error);
                }

                // æ£€æµ‹å†…ç½‘IP
                try {
                    const localIPs = await this.getLocalIPs();
                    localIPs.forEach(ip => {
                        if (!this.detectedIPs.includes(ip)) {
                            this.detectedIPs.push(ip);
                        }
                    });
                } catch (error) {
                    console.error('å†…ç½‘IPæ£€æµ‹å¤±è´¥:', error);
                }

                // æ·»åŠ å¸¸è§çš„æœ¬åœ°IP
                const commonLocalIPs = ['127.0.0.1', '::1', 'localhost'];
                commonLocalIPs.forEach(ip => {
                    if (!this.detectedIPs.includes(ip)) {
                        this.detectedIPs.push(ip);
                    }
                });

                this.realIP = this.detectedIPs[0] || 'æœªçŸ¥';
                console.log('æ£€æµ‹åˆ°çš„æ‰€æœ‰IPåœ°å€:', this.detectedIPs);
            }

            isValidIP(ip) {
                const ipv4Regex = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/;
                const ipv6Regex = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
                return ipv4Regex.test(ip) || ipv6Regex.test(ip);
            }

            async getLocalIPs() {
                return new Promise((resolve) => {
                    const ips = [];
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });

                    pc.createDataChannel('');
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                            if (ipMatch && !ips.includes(ipMatch[1])) {
                                ips.push(ipMatch[1]);
                            }
                        }
                    };

                    pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    setTimeout(() => {
                        pc.close();
                        resolve(ips);
                    }, 3000);
                });
            }

            initElements() {
                this.elements = {
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    adminBtn: document.getElementById('adminBtn'),
                    adminBadge: document.getElementById('adminBadge'),
                    onlineCount: document.getElementById('onlineCount'),
                    ipDisplay: document.getElementById('ipDisplay'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    sidebar: document.getElementById('sidebar'),
                    userList: document.getElementById('userList'),
                    userModal: document.getElementById('userModal'),
                    closeModal: document.getElementById('closeModal'),
                    userDetails: document.getElementById('userDetails')
                };
            }

            connect() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}`;

                    console.log('è¿æ¥åˆ°WebSocketæœåŠ¡å™¨:', wsUrl);
                    this.ws = new WebSocket(wsUrl);
                    this.updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');

                    this.ws.onopen = () => {
                        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                        this.updateConnectionStatus('connected', 'å·²è¿æ¥');
                        this.reconnectAttempts = 0;
                        this.reconnectDelay = 1000;
                        this.joinRoom();
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                        }
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocketè¿æ¥å·²å…³é—­', event.code, event.reason);
                        this.updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
                        this.disableChat();
                        this.attemptReconnect();
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        this.updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
                    };

                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                    this.attemptReconnect();
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`å°è¯•é‡è¿ ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);

                    this.updateConnectionStatus('connecting', `é‡è¿ä¸­... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay);

                    this.reconnectDelay = Math.min(this.reconnectDelay * 1.5, 10000);
                } else {
                    console.log('é‡è¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    this.addSystemMessage('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    this.updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                }
            }

            updateConnectionStatus(status, text) {
                this.elements.connectionStatus.className = `connection-status ${status}`;
                this.elements.connectionStatus.textContent = text;
            }

            joinRoom() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'joinRoom',
                        roomId: this.roomId
                    }));
                }
            }

            enableChat() {
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
                this.elements.messageInput.focus();
            }

            disableChat() {
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'userInit':
                        this.handleUserInit(data.user);
                        break;
                    case 'joinedRoom':
                        this.handleJoinedRoom(data);
                        break;
                    case 'userList':
                        this.handleUserList(data.users, data.onlineCount);
                        break;
                    case 'userJoined':
                        this.handleUserJoined(data.user);
                        break;
                    case 'userLeft':
                        this.handleUserLeft(data.user);
                        break;
                    case 'newMessage':
                        this.handleNewMessage(data.message);
                        break;
                    case 'systemMessage':
                        this.addSystemMessage(data.message);
                        break;
                    case 'userDetails':
                        this.showUserDetails(data.user);
                        break;
                    case 'kicked':
                        alert(data.message);
                        window.location.reload();
                        break;
                    case 'error':
                        console.error('æœåŠ¡å™¨é”™è¯¯:', data.message);
                        this.addSystemMessage('é”™è¯¯: ' + data.message);
                        break;
                    case 'ping':
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({ type: 'heartbeat' }));
                        }
                        break;
                    case 'pong':
                        break;

                    case 'userDetectionUpdate':
                        this.handleUserDetectionUpdate(data);
                        break;
                }
            }

            handleUserInit(user) {
                this.currentUser = user;
                this.isAdmin = user.isAdmin;

                // æ˜¾ç¤ºæ‰€æœ‰æ£€æµ‹åˆ°çš„IP
                const ipDisplayText = this.detectedIPs.length > 0 ? 
                    `IP: ${this.detectedIPs.join(', ')}` : 
                    `IP: ${user.ip}`;
                this.elements.ipDisplay.textContent = ipDisplayText;

                if (this.isAdmin) {
                    this.elements.adminBadge.classList.add('show');
                } else {
                    // æ˜¾ç¤ºç®¡ç†å‘˜æƒé™é…ç½®æç¤º
                    this.addAdminConfigMessage();
                }

                this.clearMessages();
                this.addSystemMessage(`æ¬¢è¿ ${user.username}ï¼${this.isAdmin ? 'æ‚¨å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚' : ''}`);
                this.enableChat();
            }

            addAdminConfigMessage() {
                const chatMessages = this.elements.chatMessages;
                const configDiv = document.createElement('div');
                configDiv.className = 'admin-config';
                configDiv.innerHTML = `
                    <strong>ğŸ”§ ç®¡ç†å‘˜æƒé™é…ç½®æç¤ºï¼š</strong><br>
                    æ£€æµ‹åˆ°æ‚¨çš„IPåœ°å€ï¼š<code>${this.detectedIPs.join(', ')}</code><br>
                    å¦‚éœ€è·å¾—ç®¡ç†å‘˜æƒé™ï¼Œè¯·åœ¨æœåŠ¡å™¨çš„ <code>adminIPs</code> æ•°ç»„ä¸­æ·»åŠ æ‚¨çš„IPåœ°å€ã€‚<br>
                    <strong>æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯åŠ¨æ€IPæˆ–é€šè¿‡ä»£ç†è®¿é—®ï¼ŒIPåœ°å€å¯èƒ½ä¼šå˜åŒ–ã€‚
                `;
                chatMessages.appendChild(configDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            handleJoinedRoom(data) {
                if (data.success) {
                    this.addSystemMessage(`å·²åŠ å…¥æˆ¿é—´ï¼š${data.roomId}`);
                }
            }

            handleUserList(users, onlineCount) {
                this.users.clear();
                users.forEach(user => this.users.set(user.id, user));

                this.elements.onlineCount.textContent = onlineCount;
                this.updateUserList();
            }

            handleUserJoined(user) {
                this.users.set(user.id, user);
                this.updateUserList();
                this.addSystemMessage(`${user.username} åŠ å…¥äº†èŠå¤©å®¤`);
            }

            handleUserLeft(user) {
                this.users.delete(user.id);
                this.updateUserList();
                this.addSystemMessage(`${user.username} ç¦»å¼€äº†èŠå¤©å®¤`);
            }

            handleNewMessage(message) {
                const isOwn = message.sender.id === this.currentUser.id;
                this.addMessage(message, isOwn);
            }

            updateUserList() {
                const userList = this.elements.userList;
                userList.innerHTML = '';

                this.users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    if (user.id === this.currentUser.id) {
                        li.classList.add('current-user');
                    }

                    li.innerHTML = `
                        <div class="username">${user.username}</div>
                        <div class="user-details">
                            ${user.isAdmin ? '<span style="color: #ff6b6b;">ğŸ‘‘ ç®¡ç†å‘˜</span>' : ''}
                            ${user.ip && !user.isAdmin ? `<br>IP: ${user.ip}` : ''}
                            ${user.joinTime ? `<br>åŠ å…¥: ${new Date(user.joinTime).toLocaleTimeString()}` : ''}
                        </div>
                        <div class="user-status ${user.isOnline ? '' : 'offline'}"></div>
                    `;

                    if (this.isAdmin && user.id !== this.currentUser.id) {
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            this.getUserDetails(user.id);
                        });
                    }

                    userList.appendChild(li);
                });

                const onlineUsers = Array.from(this.users.values()).filter(u => u.isOnline !== false);
                this.elements.onlineCount.textContent = onlineUsers.length;
            }

            addMessage(message, isOwn = false) {
                const messagesContainer = this.elements.chatMessages;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;

                const time = new Date(message.timestamp).toLocaleTimeString();
                const adminMark = message.sender.isAdmin ? '<span class="admin-info show">ğŸ‘‘</span>' : '';

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username">${message.sender.username}${adminMark}</span>
                        <span class="timestamp">${time}</span>
                    </div>
                    <div class="message-content">${this.escapeHtml(message.text)}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const loadingMsg = messagesContainer.querySelector('.loading');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
            }

            addSystemMessage(text) {
                const messagesContainer = this.elements.chatMessages;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="message-content">${this.escapeHtml(text)}</div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const loadingMsg = messagesContainer.querySelector('.loading');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
            }

            clearMessages() {
                this.elements.chatMessages.innerHTML = '';
            }

            sendMessage() {
                const input = this.elements.messageInput;
                const text = input.value.trim();

                if (!text || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    return;
                }

                this.ws.send(JSON.stringify({
                    type: 'sendMessage',
                    text: text
                }));

                input.value = '';
                input.focus();
            }

            getUserDetails(userId) {
                if (!this.isAdmin) return;

                this.ws.send(JSON.stringify({
                    type: 'getUserDetails',
                    targetUserId: userId
                }));
            }

            handleUserDetectionUpdate(data) {
                // æ›´æ–°ç”¨æˆ·è¯¦æƒ…çª—å£ä¸­çš„æ£€æµ‹ç»“æœ
                if (this.elements.userModal.style.display === 'block') {
                    this.updateDetectionResults(data.targetUserId, data);
                }
            }

            updateDetectionResults(userId, data) {
                // æ›´æ–°æœåŠ¡å™¨ç«¯Toræ£€æµ‹ç»“æœ
                const torElement = document.getElementById(`server-tor-status-${userId}`);
                if (torElement && data.torDetection) {
                    this.displayServerTorResults(userId, data.torDetection);
                }

                // æ›´æ–°æœåŠ¡å™¨ç«¯IPä¿¡æ¯
                const ipInfoElement = document.getElementById(`server-ip-info-${userId}`);
                if (ipInfoElement && data.ipInfo) {
                    this.displayServerIPInfo(userId, data.ipInfo);
                }

                // å¦‚æœæ£€æµ‹æ­£åœ¨è¿›è¡Œï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (data.detectionInProgress) {
                    const loadingElement = document.getElementById(`server-detection-loading-${userId}`);
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }
                }
            }

            showUserDetails(user) {
                const content = this.elements.userDetails;
                const browserInfo = this.getBrowserInfo(user.userAgent);
                const osInfo = this.getOSInfo(user.userAgent);

                // è·å–æ›´è¯¦ç»†çš„æµè§ˆå™¨å’Œç³»ç»Ÿä¿¡æ¯
                const detailedBrowserInfo = this.getDetailedBrowserInfo(user.userAgent);
                const screenInfo = this.getScreenInfo();
                const languageInfo = this.getLanguageInfo();
                const timezoneInfo = this.getTimezoneInfo();
                const hardwareInfo = this.getHardwareInfo();
                const networkInfo = this.getNetworkInfo();
                const securityInfo = this.getSecurityInfo();

                // å¼€å§‹WebRTC IPæ£€æµ‹
                this.detectWebRTCIPs(user.id);

                // è¯·æ±‚æœåŠ¡å™¨ç«¯æ£€æµ‹ç»“æœ
                this.requestServerDetection(user.id);

                content.innerHTML = `
                    <div class="user-detail-section">
                        <div class="section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ç”¨æˆ·ID</div>
                            <div class="user-detail-value">${user.id}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ç”¨æˆ·å</div>
                            <div class="user-detail-value">${user.username}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æœåŠ¡å™¨æ£€æµ‹IP</div>
                            <div class="user-detail-value">${user.ip || 'æœªçŸ¥IPåœ°å€'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æƒé™ç­‰çº§</div>
                            <div class="user-detail-value">${user.isAdmin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ æ™®é€šç”¨æˆ·'}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸ§… æœåŠ¡å™¨ç«¯ç½‘ç»œæ£€æµ‹</div>
                        <div id="server-detection-loading-${user.id}" style="display: ${user.detectionInProgress ? 'block' : 'none'};">
                            <div class="user-detail-item">
                                <div class="user-detail-label">ğŸ” æ£€æµ‹çŠ¶æ€</div>
                                <div class="user-detail-value">â³ æœåŠ¡å™¨æ­£åœ¨æ£€æµ‹ä¸­ï¼Œè¯·ç¨å€™...</div>
                            </div>
                        </div>
                        <div id="server-tor-status-${user.id}">
                            ${this.generateServerTorStatus(user)}
                        </div>
                        <div id="server-ip-info-${user.id}">
                            ${this.generateServerIPInfo(user)}
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸ“ IPåœ°å€ (WebRTC)</div>
                        <div id="webrtc-ip-loading-${user.id}" class="user-detail-item">
                            <div class="user-detail-label">WebRTCæ£€æµ‹çŠ¶æ€</div>
                            <div class="user-detail-value">ğŸ” æ­£åœ¨æ£€æµ‹çœŸå®IPåœ°å€...</div>
                        </div>
                        <div id="webrtc-ip-results-${user.id}" style="display: none;"></div>
                        <div id="webrtc-ip-no-results-${user.id}" style="display: none;" class="user-detail-item">
                            <div class="user-detail-label">WebRTCæ£€æµ‹ç»“æœ</div>
                            <div class="user-detail-value">âš ï¸ æœªæ‰¾åˆ°IPåœ°å€ã€‚è¿™å¯èƒ½æ˜¯ç”±äºæ‚¨çš„æµè§ˆå™¨è®¾ç½®ã€ç½‘ç»œé…ç½®ï¼ˆä¾‹å¦‚å¹¿å‘Šæ‹¦æˆªå™¨ã€é˜²ç«å¢™æˆ–ç¦ç”¨äº†WebRTCï¼‰æ‰€è‡´ã€‚</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸŒ æµè§ˆå™¨ä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æµè§ˆå™¨</div>
                            <div class="user-detail-value">${detailedBrowserInfo.name} ${detailedBrowserInfo.version}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æµè§ˆå™¨å†…æ ¸</div>
                            <div class="user-detail-value">${detailedBrowserInfo.engine}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æ“ä½œç³»ç»Ÿ</div>
                            <div class="user-detail-value">${osInfo}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">è®¾å¤‡ç±»å‹</div>
                            <div class="user-detail-value">${detailedBrowserInfo.deviceType}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">User Agent</div>
                            <div class="user-detail-value" style="word-break: break-all; font-size: 0.8em;">${user.userAgent || 'æœªçŸ¥'}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸ–¥ï¸ æ˜¾ç¤ºä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">å±å¹•åˆ†è¾¨ç‡</div>
                            <div class="user-detail-value">${screenInfo.resolution}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">å¯ç”¨å±å¹•å¤§å°</div>
                            <div class="user-detail-value">${screenInfo.availableSize}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">è‰²å½©æ·±åº¦</div>
                            <div class="user-detail-value">${screenInfo.colorDepth} ä½</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">åƒç´ æ¯”</div>
                            <div class="user-detail-value">${screenInfo.pixelRatio}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸŒ åœ°åŒºä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æ—¶åŒº</div>
                            <div class="user-detail-value">${timezoneInfo.timezone}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æ—¶åŒºåç§»</div>
                            <div class="user-detail-value">${timezoneInfo.offset}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">è¯­è¨€</div>
                            <div class="user-detail-value">${languageInfo.language}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">è¯­è¨€åˆ—è¡¨</div>
                            <div class="user-detail-value">${languageInfo.languages}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">âš™ï¸ ç¡¬ä»¶ä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">CPUæ ¸å¿ƒæ•°</div>
                            <div class="user-detail-value">${hardwareInfo.cores}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">å†…å­˜å¤§å°</div>
                            <div class="user-detail-value">${hardwareInfo.memory}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">GPUä¿¡æ¯</div>
                            <div class="user-detail-value">${hardwareInfo.gpu}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ç”µæ± çŠ¶æ€</div>
                            <div class="user-detail-value">${hardwareInfo.battery}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸŒ ç½‘ç»œä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">è¿æ¥ç±»å‹</div>
                            <div class="user-detail-value">${networkInfo.type}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ä¸‹è¡Œå¸¦å®½</div>
                            <div class="user-detail-value">${networkInfo.downlink}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ç½‘ç»œå»¶è¿Ÿ</div>
                            <div class="user-detail-value">${networkInfo.rtt}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æ•°æ®èŠ‚çœæ¨¡å¼</div>
                            <div class="user-detail-value">${networkInfo.saveData}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">ğŸ”’ å®‰å…¨ä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">Cookie å¯ç”¨</div>
                            <div class="user-detail-value">${securityInfo.cookieEnabled}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">DoNotTrack</div>
                            <div class="user-detail-value">${securityInfo.doNotTrack}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">Java å¯ç”¨</div>
                            <div class="user-detail-value">${securityInfo.javaEnabled}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">WebGLæ”¯æŒ</div>
                            <div class="user-detail-value">${securityInfo.webglSupport}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">â° æ´»åŠ¨ä¿¡æ¯</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">åŠ å…¥æ—¶é—´</div>
                            <div class="user-detail-value">${user.joinTime ? new Date(user.joinTime).toLocaleString() : 'æœªçŸ¥'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æœ€åæ´»åŠ¨</div>
                            <div class="user-detail-value">${user.lastActivity ? new Date(user.lastActivity).toLocaleString() : 'æœªçŸ¥'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">åœ¨çº¿çŠ¶æ€</div>
                            <div class="user-detail-value">${user.isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">æˆ¿é—´ID</div>
                            <div class="user-detail-value">${user.roomId || 'æœªçŸ¥'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">åœ¨çº¿æ—¶é•¿</div>
                            <div class="user-detail-value">${this.getOnlineTime(user.joinTime)}</div>
                        </div>
                    </div>

                    ${!user.isAdmin ? `
                    <div class="user-detail-section">
                        <div class="section-title">âš¡ ç®¡ç†æ“ä½œ</div>
                        <button class="kick-btn" onclick="chatClient.kickUser('${user.id}')">ğŸš« è¸¢å‡ºç”¨æˆ·</button>
                    </div>
                    ` : ''}
                `;

                this.elements.userModal.style.display = 'block';
            }

            getDetailedBrowserInfo(userAgent) {
                const info = { name: 'æœªçŸ¥', version: 'æœªçŸ¥', engine: 'æœªçŸ¥', deviceType: 'æ¡Œé¢' };

                if (userAgent.includes('Edg/')) {
                    info.name = 'Microsoft Edge';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Edg\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Chrome/')) {
                    info.name = 'Google Chrome';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Chrome\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Firefox/')) {
                    info.name = 'Mozilla Firefox';
                    info.engine = 'Gecko';
                    const match = userAgent.match(/Firefox\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Safari/')) {
                    info.name = 'Safari';
                    info.engine = 'WebKit';
                    const match = userAgent.match(/Version\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Opera/')) {
                    info.name = 'Opera';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Opera\/(\d+)/);
                    if (match) info.version = match[1];
                }

                // æ£€æµ‹è®¾å¤‡ç±»å‹
                if (userAgent.includes('Mobile')) {
                    info.deviceType = 'ç§»åŠ¨è®¾å¤‡';
                } else if (userAgent.includes('Tablet')) {
                    info.deviceType = 'å¹³æ¿ç”µè„‘';
                } else {
                    info.deviceType = 'æ¡Œé¢ç”µè„‘';
                }

                return info;
            }

            getScreenInfo() {
                return {
                    resolution: `${screen.width} Ã— ${screen.height}`,
                    availableSize: `${screen.availWidth} Ã— ${screen.availHeight}`,
                    colorDepth: screen.colorDepth,
                    pixelRatio: window.devicePixelRatio || 1
                };
            }

            getLanguageInfo() {
                return {
                    language: navigator.language || 'æœªçŸ¥',
                    languages: navigator.languages ? navigator.languages.join(', ') : 'æœªçŸ¥'
                };
            }

            getTimezoneInfo() {
                const now = new Date();
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const offset = -now.getTimezoneOffset();
                const offsetHours = Math.floor(offset / 60);
                const offsetMinutes = offset % 60;
                const offsetString = `UTC${offset >= 0 ? '+' : ''}${offsetHours}:${offsetMinutes.toString().padStart(2, '0')}`;

                return {
                    timezone: timezone,
                    offset: offsetString
                };
            }

            getHardwareInfo() {
                return {
                    cores: navigator.hardwareConcurrency || 'æœªçŸ¥',
                    memory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'æœªçŸ¥',
                    gpu: this.getGPUInfo(),
                    battery: this.getBatteryInfo()
                };
            }

            getGPUInfo() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        if (debugInfo) {
                            const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                            const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                            return `${vendor} - ${renderer}`;
                        }
                    }
                    return 'æœªçŸ¥';
                } catch (e) {
                    return 'æ— æ³•è·å–';
                }
            }

            getBatteryInfo() {
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        const level = Math.round(battery.level * 100);
                        const charging = battery.charging ? 'å……ç”µä¸­' : 'æœªå……ç”µ';
                        return `${level}% (${charging})`;
                    });
                    return 'æ£€æµ‹ä¸­...';
                }
                return 'ä¸æ”¯æŒç”µæ± æ£€æµ‹';
            }

            getNetworkInfo() {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (connection) {
                    return {
                        type: connection.effectiveType || connection.type || 'æœªçŸ¥',
                        downlink: connection.downlink ? `${connection.downlink} Mbps` : 'æœªçŸ¥',
                        rtt: connection.rtt ? `${connection.rtt} ms` : 'æœªçŸ¥',
                        saveData: connection.saveData ? 'å¯ç”¨' : 'æœªå¯ç”¨'
                    };
                }
                return { type: 'æœªçŸ¥', downlink: 'æœªçŸ¥', rtt: 'æœªçŸ¥', saveData: 'æœªçŸ¥' };
            }

            getSecurityInfo() {
                return {
                    cookieEnabled: navigator.cookieEnabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨',
                    doNotTrack: navigator.doNotTrack === '1' ? 'å¯ç”¨' : 'æœªå¯ç”¨',
                    javaEnabled: navigator.javaEnabled ? (navigator.javaEnabled() ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨') : 'âŒ ä¸æ”¯æŒ',
                    webglSupport: this.checkWebGLSupport()
                };
            }

            checkWebGLSupport() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    return gl ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
                } catch (e) {
                    return 'âŒ ä¸æ”¯æŒ';
                }
            }

            getOnlineTime(joinTime) {
                if (!joinTime) return 'æœªçŸ¥';

                const now = new Date();
                const start = new Date(joinTime);
                const diff = now - start;

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                if (hours > 0) {
                    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                } else if (minutes > 0) {
                    return `${minutes}åˆ†é’Ÿ${seconds}ç§’`;
                } else {
                    return `${seconds}ç§’`;
                }
            }

            requestServerDetection(userId) {
                if (!this.isAdmin) return;

                this.ws.send(JSON.stringify({
                    type: 'requestDetection',
                    targetUserId: userId
                }));
            }

            generateServerTorStatus(user) {
                if (user.torDetection) {
                    return this.formatServerTorResults(user.id, user.torDetection);
                } else if (user.detectionInProgress) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ§… æœåŠ¡å™¨ç«¯Toræ£€æµ‹</div>
                            <div class="user-detail-value">ğŸ” æœåŠ¡å™¨æ­£åœ¨æ£€æµ‹...</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ§… æœåŠ¡å™¨ç«¯Toræ£€æµ‹</div>
                            <div class="user-detail-value">â³ ç­‰å¾…æœåŠ¡å™¨æ£€æµ‹ç»“æœ...</div>
                        </div>
                    `;
                }
            }

            generateServerIPInfo(user) {
                if (user.ipInfo && user.ipInfo.success) {
                    return this.formatServerIPInfo(user.id, user.ipInfo);
                } else if (user.detectionInProgress) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸŒ æœåŠ¡å™¨ç«¯IPä¿¡æ¯</div>
                            <div class="user-detail-value">ğŸ” æœåŠ¡å™¨æ­£åœ¨è·å–...</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸŒ æœåŠ¡å™¨ç«¯IPä¿¡æ¯</div>
                            <div class="user-detail-value">â³ ç­‰å¾…æœåŠ¡å™¨è·å–ç»“æœ...</div>
                        </div>
                    `;
                }
            }

            displayServerTorResults(userId, torDetection) {
                const element = document.getElementById(`server-tor-status-${userId}`);
                if (element) {
                    element.innerHTML = this.formatServerTorResults(userId, torDetection);
                }

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                const loading = document.getElementById(`server-detection-loading-${userId}`);
                if (loading) {
                    loading.style.display = 'none';
                }
            }

            formatServerTorResults(userId, torDetection) {
                const resultStatus = torDetection.isTor ? 
                    `ğŸ§… <span style="color: #ff6b6b; font-weight: bold;">æœåŠ¡å™¨ç¡®è®¤: æ­£åœ¨ä½¿ç”¨Torç½‘ç»œ</span>` :
                    `ğŸŒ <span style="color: #2ecc71; font-weight: bold;">æœåŠ¡å™¨ç¡®è®¤: æœªä½¿ç”¨Torç½‘ç»œ</span>`;

                let html = `
                    <div class="user-detail-item">
                        <div class="user-detail-label">ğŸ§… æœåŠ¡å™¨ç«¯Toræ£€æµ‹</div>
                        <div class="user-detail-value">${resultStatus}</div>
                    </div>
                `;

                if (torDetection.torExitNode) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸšª Torå‡ºå£èŠ‚ç‚¹</div>
                            <div class="user-detail-value">âœ… <span style="color: #ff6b6b;">ç¡®è®¤ä¸ºTorå‡ºå£èŠ‚ç‚¹</span></div>
                        </div>
                    `;
                }

                html += `
                    <div class="user-detail-item">
                        <div class="user-detail-label">ğŸ“‹ æœåŠ¡å™¨æ£€æµ‹è¯¦æƒ…</div>
                        <div class="user-detail-value">
                            ${torDetection.detectionDetails.map(detail => `â€¢ ${detail}`).join('<br>')}<br>
                            <small style="color: #666;">æ£€æµ‹æ—¶é—´: ${new Date().toLocaleString()}</small>
                        </div>
                    </div>
                `;

                if (torDetection.error) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">âš ï¸ æ£€æµ‹é”™è¯¯</div>
                            <div class="user-detail-value" style="color: #e74c3c;">${torDetection.error}</div>
                        </div>
                    `;
                }

                return html;
            }

            displayServerIPInfo(userId, ipInfo) {
                const element = document.getElementById(`server-ip-info-${userId}`);
                if (element) {
                    element.innerHTML = this.formatServerIPInfo(userId, ipInfo);
                }
            }

            formatServerIPInfo(userId, ipInfo) {
                if (!ipInfo.success) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸŒ æœåŠ¡å™¨ç«¯IPä¿¡æ¯</div>
                            <div class="user-detail-value">âŒ è·å–å¤±è´¥: ${ipInfo.error}</div>
                        </div>
                    `;
                }

                const data = ipInfo.data;
                let html = `
                    <div class="user-detail-item">
                        <div class="user-detail-label">ğŸŒ IPä¿¡æ¯æ¥æº</div>
                        <div class="user-detail-value">âœ… ${ipInfo.source}</div>
                    </div>
                `;

                // å¤„ç†ä¸åŒæœåŠ¡çš„æ•°æ®æ ¼å¼
                if (data.country || data.countryCode) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸŒ åœ°ç†ä½ç½®</div>
                            <div class="user-detail-value">
                                ${data.city || data.regionName || 'æœªçŸ¥'}, ${data.region || data.regionName || 'æœªçŸ¥'}, ${data.country || 'æœªçŸ¥'}
                                ${data.countryCode ? ` (${data.countryCode})` : ''}<br>
                                ${data.lat && data.lon ? `<small>ç»çº¬åº¦: ${data.lat}, ${data.lon}</small>` : ''}
                                ${data.loc ? `<small>ç»çº¬åº¦: ${data.loc}</small>` : ''}
                            </div>
                        </div>
                    `;
                }

                if (data.org || data.isp || data.as) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ¢ ISPä¿¡æ¯</div>
                            <div class="user-detail-value">
                                ç»„ç»‡: ${data.org || data.isp || data.asname || 'æœªçŸ¥'}<br>
                                ${data.as ? `ASå·: ${data.as}<br>` : ''}
                                ${data.hostname || data.reverse ? `ä¸»æœºå: ${data.hostname || data.reverse}<br>` : ''}
                                ${data.timezone ? `æ—¶åŒº: ${data.timezone}` : ''}
                            </div>
                        </div>
                    `;
                }

                if (data.proxy !== undefined || data.hosting !== undefined || data.mobile !== undefined) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ” è¿æ¥ç‰¹å¾</div>
                            <div class="user-detail-value">
                                ${data.proxy !== undefined ? `ä»£ç†: ${data.proxy ? 'æ˜¯' : 'å¦'}<br>` : ''}
                                ${data.hosting !== undefined ? `æ‰˜ç®¡æœåŠ¡: ${data.hosting ? 'æ˜¯' : 'å¦'}<br>` : ''}
                                ${data.mobile !== undefined ? `ç§»åŠ¨ç½‘ç»œ: ${data.mobile ? 'æ˜¯' : 'å¦'}` : ''}
                            </div>
                        </div>
                    `;
                }

                return html;
            }

            async detectTorConnection(userId, userIP) {
                // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸»è¦ç”¨äºå®¢æˆ·ç«¯æ£€æµ‹ä½œä¸ºè¡¥å……
                if (!this.isAdmin || !userIP) return;

                const torElement = document.getElementById(`tor-status-${userId}`);
                if (!torElement) return;

                try {
                    let torDetected = false;
                    let ipInfo = null;
                    let detectionDetails = [];

                    // æ–¹æ³•1: ç›´æ¥ä½¿ç”¨Tor Projectå®˜æ–¹APIæ£€æµ‹IP
                    try {
                        const torCheckUrl = `https://check.torproject.org/api/ip?ip=${encodeURIComponent(userIP)}`;
                        const torResponse = await fetch(torCheckUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (torResponse.ok) {
                            const torData = await torResponse.json();
                            torDetected = torData.IsTor === true;
                            detectionDetails.push(`Torå®˜æ–¹æ£€æµ‹: ${torDetected ? 'æ˜¯TorèŠ‚ç‚¹' : 'éTorèŠ‚ç‚¹'}`);
                        }
                    } catch (torError) {
                        console.warn('Torå®˜æ–¹APIæ£€æµ‹å¤±è´¥:', torError);
                        detectionDetails.push('Torå®˜æ–¹API: æ£€æµ‹å¤±è´¥ (CORSé™åˆ¶)');
                    }

                    // æ–¹æ³•2: ä½¿ç”¨IPInfo.ioè·å–è¯¦ç»†ä¿¡æ¯
                    try {
                        const ipinfoUrl = `https://ipinfo.io/${encodeURIComponent(userIP)}/json`;
                        const ipinfoResponse = await fetch(ipinfoUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (ipinfoResponse.ok) {
                            ipInfo = await ipinfoResponse.json();

                            // æ£€æŸ¥ç»„ç»‡ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å«Torç›¸å…³å…³é”®è¯
                            const org = (ipInfo.org || '').toLowerCase();
                            const isp = (ipInfo.hostname || '').toLowerCase();
                            const torKeywords = ['tor', 'onion', 'relay', 'exit', 'proxy', 'anonymous', 'privacy'];

                            const hasTorKeywords = torKeywords.some(keyword => 
                                org.includes(keyword) || isp.includes(keyword)
                            );

                            if (hasTorKeywords && !torDetected) {
                                torDetected = true;
                                detectionDetails.push('IPInfoæ£€æµ‹: ç–‘ä¼¼TorèŠ‚ç‚¹ (åŸºäºISPä¿¡æ¯)');
                            } else {
                                detectionDetails.push(`IPInfoæ£€æµ‹: ${ipInfo.org || 'æœªçŸ¥ISP'}`);
                            }
                        }
                    } catch (ipinfoError) {
                        console.warn('IPInfoæ£€æµ‹å¤±è´¥:', ipinfoError);
                        detectionDetails.push('IPInfo.io: æ£€æµ‹å¤±è´¥');
                    }

                    // æ–¹æ³•3: æ£€æŸ¥Torå‡ºå£èŠ‚ç‚¹åˆ—è¡¨
                    if (!torDetected) {
                        try {
                            const exitListResponse = await fetch('https://check.torproject.org/torbulkexitlist', {
                                method: 'GET',
                                mode: 'cors',
                                cache: 'no-cache'
                            });

                            if (exitListResponse.ok) {
                                const exitList = await exitListResponse.text();
                                if (exitList.includes(userIP)) {
                                    torDetected = true;
                                    detectionDetails.push('Torå‡ºå£åˆ—è¡¨: ç¡®è®¤ä¸ºTorå‡ºå£èŠ‚ç‚¹');
                                } else {
                                    detectionDetails.push('Torå‡ºå£åˆ—è¡¨: éå‡ºå£èŠ‚ç‚¹');
                                }
                            }
                        } catch (exitError) {
                            console.warn('Torå‡ºå£åˆ—è¡¨æ£€æŸ¥å¤±è´¥:', exitError);
                            detectionDetails.push('Torå‡ºå£åˆ—è¡¨: æ£€æµ‹å¤±è´¥');
                        }
                    }

                    // æ„å»ºç»“æœæ˜¾ç¤º
                    const resultHtml = torDetected ? 
                        `ğŸ§… <span style="color: #ff6b6b; font-weight: bold;">æ­£åœ¨ä½¿ç”¨Torç½‘ç»œ</span>` :
                        `ğŸŒ <span style="color: #2ecc71; font-weight: bold;">æœªä½¿ç”¨Torç½‘ç»œ</span>`;

                    let detailsHtml = `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ§… Torç½‘ç»œçŠ¶æ€</div>
                            <div class="user-detail-value">${resultHtml}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ” æ£€æµ‹ç›®æ ‡IP</div>
                            <div class="user-detail-value">${userIP}</div>
                        </div>
                    `;

                    // æ˜¾ç¤ºIPInfoè¯¦ç»†ä¿¡æ¯
                    if (ipInfo) {
                        detailsHtml += `
                            <div class="user-detail-item">
                                <div class="user-detail-label">ğŸŒ åœ°ç†ä½ç½®</div>
                                <div class="user-detail-value">
                                    ${ipInfo.city || 'æœªçŸ¥'}, ${ipInfo.region || 'æœªçŸ¥'}, ${ipInfo.country || 'æœªçŸ¥'}<br>
                                    <small>ç»çº¬åº¦: ${ipInfo.loc || 'æœªçŸ¥'}</small>
                                </div>
                            </div>
                            <div class="user-detail-item">
                                <div class="user-detail-label">ğŸ¢ ISPä¿¡æ¯</div>
                                <div class="user-detail-value">
                                    ç»„ç»‡: ${ipInfo.org || 'æœªçŸ¥'}<br>
                                    ä¸»æœºå: ${ipInfo.hostname || 'æœªçŸ¥'}<br>
                                    æ—¶åŒº: ${ipInfo.timezone || 'æœªçŸ¥'}
                                </div>
                            </div>
                        `;
                    }

                    // æ˜¾ç¤ºæ£€æµ‹è¯¦æƒ…
                    detailsHtml += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ“‹ æ£€æµ‹è¯¦æƒ…</div>
                            <div class="user-detail-value">
                                ${detectionDetails.map(detail => `â€¢ ${detail}`).join('<br>')}<br>
                                <small style="color: #666;">æ£€æµ‹æ—¶é—´: ${new Date().toLocaleString()}</small>
                            </div>
                        </div>
                    `;

                    torElement.innerHTML = detailsHtml;

                } catch (error) {
                    console.error('Toræ£€æµ‹å¤±è´¥:', error);

                    torElement.innerHTML = `
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ§… Torç½‘ç»œæ£€æµ‹</div>
                            <div class="user-detail-value">
                                âš ï¸ <span style="color: #e74c3c;">æ£€æµ‹å¤±è´¥</span><br>
                                <small style="color: #666;">
                                    æ£€æµ‹IP: ${userIP}<br>
                                    é”™è¯¯: ${error.message}<br>
                                    è¿™å¯èƒ½ç”±äºCORSç­–ç•¥ã€ç½‘ç»œé™åˆ¶æˆ–APIæœåŠ¡å¼‚å¸¸å¯¼è‡´
                                </small>
                            </div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">ğŸ’¡ æ‰‹åŠ¨æ£€æµ‹é“¾æ¥</div>
                            <div class="user-detail-value">
                                <a href="https://check.torproject.org/api/ip?ip=${encodeURIComponent(userIP)}" target="_blank" style="color: #667eea;">
                                    ğŸ§… Torå®˜æ–¹æ£€æµ‹
                                </a><br>
                                <a href="https://ipinfo.io/${encodeURIComponent(userIP)}" target="_blank" style="color: #667eea;">
                                    ğŸŒ IPInfoè¯¦æƒ…
                                </a>
                            </div>
                        </div>
                    `;
                }
            }

            async heuristicTorDetection() {
                try {
                    // å¯å‘å¼æ£€æµ‹æ–¹æ³•ï¼šæ£€æŸ¥å¸¸è§çš„Torç‰¹å¾
                    const checks = [];

                    // æ£€æŸ¥1: æ—¶åŒºå’Œè¯­è¨€ä¸åŒ¹é…ï¼ˆå¸¸è§çš„åŒ¿ååŒ–ç‰¹å¾ï¼‰
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const language = navigator.language;

                    // æ£€æŸ¥2: WebRTCæ˜¯å¦è¢«ç¦ç”¨ï¼ˆè®¸å¤šTorç”¨æˆ·ä¼šç¦ç”¨WebRTCï¼‰
                    const webrtcDisabled = await this.checkWebRTCDisabled();
                    if (webrtcDisabled) checks.push('WebRTCè¢«ç¦ç”¨');

                    // æ£€æŸ¥3: ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ç‰¹å¾
                    const userAgent = navigator.userAgent;
                    const torBrowserPatterns = [
                        /Firefox\/\d+\.\d+$/,  // Toræµè§ˆå™¨é€šå¸¸åŸºäºFirefoxä¸”ç‰ˆæœ¬å·æ ¼å¼ç‰¹æ®Š
                        /Windows NT 10\.0.*Firefox/  // ç‰¹å®šçš„Windows+Firefoxç»„åˆ
                    ];

                    const hasTorPattern = torBrowserPatterns.some(pattern => pattern.test(userAgent));
                    if (hasTorPattern) checks.push('ç–‘ä¼¼Toræµè§ˆå™¨ç‰¹å¾');

                    // æ£€æŸ¥4: å±å¹•åˆ†è¾¨ç‡æ˜¯å¦ä¸ºå¸¸è§çš„åŒ¿ååŒ–åˆ†è¾¨ç‡
                    const commonTorResolutions = [
                        '1000x700', '1200x800', '1400x900', '1600x900'
                    ];
                    const currentResolution = `${screen.width}x${screen.height}`;
                    if (commonTorResolutions.includes(currentResolution)) {
                        checks.push('ä½¿ç”¨å¸¸è§åŒ¿ååŒ–åˆ†è¾¨ç‡');
                    }

                    // æ£€æŸ¥5: æ’ä»¶æ•°é‡ï¼ˆToræµè§ˆå™¨é€šå¸¸ç¦ç”¨å¤§éƒ¨åˆ†æ’ä»¶ï¼‰
                    if (navigator.plugins.length === 0) {
                        checks.push('æ²¡æœ‰æµè§ˆå™¨æ’ä»¶');
                    }

                    console.log('Torå¯å‘å¼æ£€æµ‹ç»“æœ:', checks);

                    // å¦‚æœæœ‰3ä¸ªæˆ–ä»¥ä¸Šç‰¹å¾åŒ¹é…ï¼Œè®¤ä¸ºå¯èƒ½æ˜¯Tor
                    return checks.length >= 3;

                } catch (error) {
                    console.error('å¯å‘å¼Toræ£€æµ‹å¤±è´¥:', error);
                    return false;
                }
            }

            async checkWebRTCDisabled() {
                return new Promise((resolve) => {
                    try {
                        const pc = new RTCPeerConnection();
                        pc.createDataChannel('test');

                        const timeout = setTimeout(() => {
                            pc.close();
                            resolve(true); // å¦‚æœè¶…æ—¶ï¼Œè®¤ä¸ºWebRTCè¢«ç¦ç”¨
                        }, 1000);

                        pc.onicecandidate = (event) => {
                            clearTimeout(timeout);
                            pc.close();
                            resolve(false); // æœ‰ICEå€™é€‰ï¼ŒWebRTCæ­£å¸¸å·¥ä½œ
                        };

                        pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    } catch (error) {
                        resolve(true); // å‡ºé”™è®¤ä¸ºWebRTCè¢«ç¦ç”¨
                    }
                });
            }

            detectWebRTCIPs(userId) {
                if (!this.isAdmin) return;

                const loadingElement = document.getElementById(`webrtc-ip-loading-${userId}`);
                const resultsElement = document.getElementById(`webrtc-ip-results-${userId}`);
                const noResultsElement = document.getElementById(`webrtc-ip-no-results-${userId}`);

                this.getIPs(userId, async (ip) => {
                    if (ip) {
                        // éšè—åŠ è½½çŠ¶æ€
                        loadingElement.style.display = 'none';

                        // åˆ›å»ºIPæ¡ç›®
                        const entry = document.createElement('div');
                        entry.className = 'user-detail-item';
                        entry.style.marginBottom = '10px';

                        const header = document.createElement('div');
                        header.style.display = 'flex';
                        header.style.justifyContent = 'space-between';
                        header.style.alignItems = 'center';
                        header.style.marginBottom = '8px';

                        const address = document.createElement('span');
                        address.className = 'user-detail-label';
                        address.textContent = `ğŸ“ ${ip}`;

                        const typeSpan = document.createElement('span');
                        typeSpan.style.padding = '2px 8px';
                        typeSpan.style.borderRadius = '12px';
                        typeSpan.style.fontSize = '0.7rem';
                        typeSpan.style.fontWeight = 'bold';

                        header.appendChild(address);
                        header.appendChild(typeSpan);

                        const geo = document.createElement('div');
                        geo.className = 'user-detail-value';
                        geo.textContent = 'ğŸ” æ­£åœ¨è·å–åœ°ç†ä½ç½®...';

                        entry.appendChild(header);
                        entry.appendChild(geo);

                        if (resultsElement.style.display === 'none') {
                            resultsElement.innerHTML = '';
                            resultsElement.style.display = 'block';
                        }
                        resultsElement.appendChild(entry);

                        try {
                            const response = await fetch(`https://ipapi.co/${ip}/json/`);
                            const data = await response.json();

                            if (!data.error) {
                                const locationParts = [data.city, data.region, data.country_name].filter(Boolean);
                                const location = locationParts.length > 0 ? locationParts.join(', ') : 'åœ°ç†ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                                const isp = data.org || 'ISPä¿¡æ¯ä¸å¯ç”¨';

                                geo.innerHTML = `
                                    <div style="margin-bottom: 4px;"><strong>ğŸ“ ä½ç½®:</strong> ${location}</div>
                                    <div style="margin-bottom: 4px;"><strong>ğŸ¢ ISP:</strong> ${isp}</div>
                                    ${data.timezone ? `<div><strong>ğŸ•’ æ—¶åŒº:</strong> ${data.timezone}</div>` : ''}
                                `;

                                if (this.isPublicIP(ip)) {
                                    typeSpan.style.background = '#e74c3c';
                                    typeSpan.style.color = 'white';
                                    typeSpan.textContent = data.ip && data.ip.includes(':') ? 'IPv6 å…¬ç½‘' : 'å…¬ç½‘IP';
                                } else {
                                    typeSpan.style.background = '#3498db';
                                    typeSpan.style.color = 'white';
                                    typeSpan.textContent = 'å†…ç½‘IP';
                                }
                            } else if (data.reason === 'Reserved IP Address') {
                                geo.innerHTML = '<div><strong>ğŸ  ç±»å‹:</strong> æœ¬åœ°ç½‘ç»œåœ°å€</div>';
                                typeSpan.style.background = '#3498db';
                                typeSpan.style.color = 'white';
                                typeSpan.textContent = 'å†…ç½‘IP';
                            } else {
                                geo.innerHTML = '<div><strong>âš ï¸ çŠ¶æ€:</strong> åœ°ç†ä½ç½®ä¿¡æ¯ä¸å¯ç”¨</div>';
                                typeSpan.style.background = '#95a5a6';
                                typeSpan.style.color = 'white';
                                typeSpan.textContent = 'æœªçŸ¥';
                            }
                        } catch (error) {
                            console.error('Geolocation fetch error:', error);
                            geo.innerHTML = '<div><strong>âŒ é”™è¯¯:</strong> è·å–åœ°ç†ä½ç½®æ—¶å‡ºé”™</div>';
                            typeSpan.style.background = '#e67e22';
                            typeSpan.style.color = 'white';
                            typeSpan.textContent = 'è·å–å¤±è´¥';
                        }
                    }
                });

                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    if (resultsElement.style.display === 'none') {
                        loadingElement.style.display = 'none';
                        noResultsElement.style.display = 'block';
                    }
                }, 5000);
            }

            getIPs(userId, callback) {
                const ip_dups = {};

                let RTCPeerConnection = window.RTCPeerConnection
                    || window.mozRTCPeerConnection
                    || window.webkitRTCPeerConnection;

                if (!RTCPeerConnection) {
                    // å°è¯•ä»iframeè·å–
                    const iframe = document.getElementById('iframe');
                    if (iframe) {
                        const win = iframe.contentWindow;
                        RTCPeerConnection = win.RTCPeerConnection
                            || win.mozRTCPeerConnection
                            || win.webkitRTCPeerConnection;
                    }
                }

                if (!RTCPeerConnection) {
                    console.error('RTCPeerConnectionä¸æ”¯æŒ');
                    return;
                }

                const mediaConstraints = {
                    optional: [{RtpDataChannels: true}]
                };

                const servers = {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                        { urls: "stun:stun2.l.google.com:19302" }
                    ]
                };

                let pc;
                try {
                    pc = new RTCPeerConnection(servers, mediaConstraints);
                } catch (error) {
                    console.error('åˆ›å»ºRTCPeerConnectionå¤±è´¥:', error);
                    return;
                }

                const handleCandidate = (candidate) => {
                    const ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
                    const ip_addr_match = ip_regex.exec(candidate);

                    if (!ip_addr_match) return;
                    const ip_addr = ip_addr_match[1];

                    if (ip_dups[ip_addr] === undefined) {
                        callback(ip_addr);
                    }
                    ip_dups[ip_addr] = true;
                };

                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        handleCandidate(ice.candidate.candidate);
                    }
                };

                try {
                    pc.createDataChannel("");
                } catch (error) {
                    console.error('åˆ›å»ºæ•°æ®é€šé“å¤±è´¥:', error);
                    pc.close();
                    return;
                }

                pc.createOffer().then((result) => {
                    return pc.setLocalDescription(result);
                }).catch((error) => {
                    console.error('è®¾ç½®æœ¬åœ°æè¿°å¤±è´¥:', error);
                    pc.close();
                });

                // å¤‡ç”¨æ–¹æ³•ï¼šè§£æSDP
                setTimeout(() => {
                    if (pc.localDescription && pc.localDescription.sdp) {
                        const lines = pc.localDescription.sdp.split('\n');
                        lines.forEach((line) => {
                            if (line.indexOf('a=candidate:') === 0) {
                                handleCandidate(line);
                            }
                        });
                    }
                    pc.close();
                }, 2000);
            }

            isPublicIP(ip) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºå…¬ç½‘IP
                const ipInt = ip.split('.').map(Number);

                // ç§æœ‰IPèŒƒå›´
                const privateRanges = [
                    [10, 0, 0, 0, 10, 255, 255, 255],        // 10.0.0.0/8
                    [172, 16, 0, 0, 172, 31, 255, 255],      // 172.16.0.0/12
                    [192, 168, 0, 0, 192, 168, 255, 255],    // 192.168.0.0/16
                    [127, 0, 0, 0, 127, 255, 255, 255],      // 127.0.0.0/8 (loopback)
                    [169, 254, 0, 0, 169, 254, 255, 255],    // 169.254.0.0/16 (link-local)
                    [224, 0, 0, 0, 255, 255, 255, 255]       // 224.0.0.0/4 (multicast)
                ];

                for (const range of privateRanges) {
                    const [r1, r2, r3, r4, r5, r6, r7, r8] = range;
                    if (ipInt[0] >= r1 && ipInt[0] <= r5 &&
                        ipInt[1] >= r2 && ipInt[1] <= r6 &&
                        ipInt[2] >= r3 && ipInt[2] <= r7 &&
                        ipInt[3] >= r4 && ipInt[3] <= r8) {
                        return false;
                    }
                }

                return true;
            }



            getBrowserInfo(userAgent) {
                const browsers = [
                    { name: 'Chrome', pattern: /Chrome\/(\d+)/ },
                    { name: 'Firefox', pattern: /Firefox\/(\d+)/ },
                    { name: 'Safari', pattern: /Safari\/(\d+)/ },
                    { name: 'Edge', pattern: /Edge\/(\d+)/ },
                    { name: 'Opera', pattern: /Opera\/(\d+)/ }
                ];

                for (const browser of browsers) {
                    const match = userAgent.match(browser.pattern);
                    if (match) {
                        return { name: browser.name, version: match[1] };
                    }
                }

                return { name: 'æœªçŸ¥', version: '' };
            }

            getOSInfo(userAgent) {
                if (userAgent.includes('Windows')) return 'Windows';
                if (userAgent.includes('Mac')) return 'macOS';
                if (userAgent.includes('Linux')) return 'Linux';
                if (userAgent.includes('Android')) return 'Android';
                if (userAgent.includes('iOS')) return 'iOS';
                return 'æœªçŸ¥';
            }

            kickUser(userId) {
                if (!this.isAdmin) return;

                if (confirm('ç¡®å®šè¦è¸¢å‡ºæ­¤ç”¨æˆ·å—ï¼Ÿ')) {
                    this.ws.send(JSON.stringify({
                        type: 'kickUser',
                        targetUserId: userId
                    }));
                    this.elements.userModal.style.display = 'none';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            bindEvents() {
                this.elements.sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });

                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.elements.adminBtn.addEventListener('click', () => {
                    this.toggleSidebar();
                });

                this.elements.closeModal.addEventListener('click', () => {
                    this.elements.userModal.style.display = 'none';
                });

                window.addEventListener('click', (e) => {
                    if (e.target === this.elements.userModal) {
                        this.elements.userModal.style.display = 'none';
                    }
                });

                // æ·»åŠ å³é”®å¤åˆ¶åŠŸèƒ½
                this.setupContextMenu();

                // ç§»åŠ¨ç«¯ä¼˜åŒ–äº‹ä»¶
                this.addMobileOptimizations();
            }

            setupContextMenu() {
                const contextMenu = document.getElementById('contextMenu');
                const copyMessage = document.getElementById('copyMessage');
                const copyUsername = document.getElementById('copyUsername');
                const copyTime = document.getElementById('copyTime');
                let currentMessage = null;

                // ç›‘å¬å³é”®ç‚¹å‡»æ¶ˆæ¯
                this.elements.chatMessages.addEventListener('contextmenu', (e) => {
                    const messageElement = e.target.closest('.message');
                    if (messageElement && !messageElement.classList.contains('system')) {
                        e.preventDefault();
                        currentMessage = messageElement;

                        // æ˜¾ç¤ºå³é”®èœå•
                        contextMenu.style.display = 'block';
                        contextMenu.style.left = e.pageX + 'px';
                        contextMenu.style.top = e.pageY + 'px';

                        // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•
                        const rect = contextMenu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            contextMenu.style.left = (e.pageX - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            contextMenu.style.top = (e.pageY - rect.height) + 'px';
                        }
                    }
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
                document.addEventListener('click', () => {
                    contextMenu.style.display = 'none';
                });

                // å¤åˆ¶æ¶ˆæ¯å†…å®¹
                copyMessage.addEventListener('click', () => {
                    if (currentMessage) {
                        const messageContent = currentMessage.querySelector('.message-content');
                        if (messageContent) {
                            this.copyToClipboard(messageContent.textContent);
                            this.showCopyNotification('æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶');
                        }
                    }
                    contextMenu.style.display = 'none';
                });

                // å¤åˆ¶ç”¨æˆ·å
                copyUsername.addEventListener('click', () => {
                    if (currentMessage) {
                        const username = currentMessage.querySelector('.username');
                        if (username) {
                            // ç§»é™¤ç®¡ç†å‘˜æ ‡è¯†ç¬¦
                            const usernameText = username.textContent.replace(/ğŸ‘‘/g, '').trim();
                            this.copyToClipboard(usernameText);
                            this.showCopyNotification('ç”¨æˆ·åå·²å¤åˆ¶');
                        }
                    }
                    contextMenu.style.display = 'none';
                });

                // å¤åˆ¶æ—¶é—´
                copyTime.addEventListener('click', () => {
                    if (currentMessage) {
                        const timestamp = currentMessage.querySelector('.timestamp');
                        if (timestamp) {
                            this.copyToClipboard(timestamp.textContent);
                            this.showCopyNotification('æ—¶é—´å·²å¤åˆ¶');
                        }
                    }
                    contextMenu.style.display = 'none';
                });
            }

            copyToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    // ä½¿ç”¨ç°ä»£ Clipboard API
                    navigator.clipboard.writeText(text).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        this.fallbackCopyToClipboard(text);
                    });
                } else {
                    // å›é€€æ–¹æ¡ˆ
                    this.fallbackCopyToClipboard(text);
                }
            }

            fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                }

                document.body.removeChild(textArea);
            }

            showCopyNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'copy-notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }

            addMobileOptimizations() {
                // é˜²æ­¢åŒå‡»ç¼©æ”¾å’Œæ‰‹åŠ¿ç¼©æ”¾
                let lastTouchEnd = 0;
                let initialDistance = 0;
                let isZooming = false;

                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });

                // é˜²æ­¢æ‰‹åŠ¿ç¼©æ”¾
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                        const dx = e.touches[0].pageX - e.touches[1].pageX;
                        const dy = e.touches[0].pageY - e.touches[1].pageY;
                        initialDistance = Math.sqrt(dx * dx + dy * dy);
                        isZooming = true;
                    }
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 1 && isZooming) {
                        e.preventDefault();
                    }
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    isZooming = false;
                }, { passive: false });

                // å¤„ç†è™šæ‹Ÿé”®ç›˜å¼¹å‡ºå’Œæ”¶èµ·
                let viewport = window.visualViewport;
                let initialViewportHeight = window.innerHeight;

                const handleViewportChange = () => {
                    if (viewport) {
                        const heightDiff = initialViewportHeight - viewport.height;
                        if (heightDiff > 150) { // é”®ç›˜å¼¹å‡º
                            document.body.style.setProperty('--keyboard-height', `${heightDiff}px`);
                            setTimeout(() => {
                                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                            }, 100);
                        } else { // é”®ç›˜æ”¶èµ·
                            document.body.style.setProperty('--keyboard-height', '0px');
                        }
                    }
                };

                if (viewport) {
                    viewport.addEventListener('resize', handleViewportChange);
                } else {
                    // å…¼å®¹ä¸æ”¯æŒ visualViewport çš„è®¾å¤‡
                    window.addEventListener('resize', () => {
                        const heightDiff = initialViewportHeight - window.innerHeight;
                        if (heightDiff > 150) {
                            setTimeout(() => {
                                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                            }, 100);
                        }
                    });
                }

                // è¾“å…¥æ¡†èšç„¦æ—¶çš„å¤„ç†
                this.elements.messageInput.addEventListener('focus', () => {
                    // iOS Safari ç‰¹æ®Šå¤„ç†
                    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                            this.elements.messageInput.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 300);
                    }

                    setTimeout(() => {
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                    }, 300);
                });

                // è¾“å…¥æ¡†å¤±ç„¦æ—¶çš„å¤„ç†
                this.elements.messageInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        if (viewport) {
                            window.scrollTo(0, 0);
                        }
                    }, 100);
                });

                // ä¾§è¾¹æ åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»å¤–éƒ¨å…³é—­
                document.addEventListener('click', (e) => {
                    if (this.sidebarVisible && window.innerWidth <= 768) {
                        if (!this.elements.sidebar.contains(e.target) && 
                            !this.elements.adminBtn.contains(e.target)) {
                            this.toggleSidebar();
                        }
                    }
                });

                // è§¦æ‘¸æ»‘åŠ¨å…³é—­ä¾§è¾¹æ 
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                this.elements.sidebar.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                }, { passive: true });

                this.elements.sidebar.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diffX = startX - currentX;

                    if (diffX > 0) {
                        this.elements.sidebar.style.transform = `translateX(-${diffX}px)`;
                    }
                }, { passive: true });

                this.elements.sidebar.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;

                    const diffX = startX - currentX;
                    if (diffX > 100) {
                        this.toggleSidebar();
                    } else {
                        this.elements.sidebar.style.transform = 'translateX(0)';
                    }
                }, { passive: true });

                // æ–¹å‘å˜åŒ–æ—¶é‡æ–°è°ƒæ•´
                const handleOrientationChange = () => {
                    setTimeout(() => {
                        initialViewportHeight = window.innerHeight;
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;

                        // é‡æ–°è®¡ç®—å¸ƒå±€
                        if (this.sidebarVisible && window.innerWidth > 768) {
                            this.toggleSidebar();
                        }
                    }, 300);
                };

                window.addEventListener('orientationchange', handleOrientationChange);
                screen.orientation && screen.orientation.addEventListener('change', handleOrientationChange);

                // é˜²æ­¢é€‰æ‹©æ–‡æœ¬å’Œé•¿æŒ‰èœå•
                const preventSelection = (e) => {
                    e.preventDefault();
                    return false;
                };

                this.elements.sendBtn.addEventListener('selectstart', preventSelection);
                this.elements.adminBtn.addEventListener('selectstart', preventSelection);
                this.elements.sendBtn.addEventListener('contextmenu', preventSelection);
                this.elements.adminBtn.addEventListener('contextmenu', preventSelection);

                // å¤„ç†çŠ¶æ€æ é«˜åº¦ï¼ˆåˆ˜æµ·å±ç­‰ï¼‰
                const updateSafeArea = () => {
                    const safeAreaTop = getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-top)') || '0px';
                    const safeAreaBottom = getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || '0px';

                    document.documentElement.style.setProperty('--safe-area-top', safeAreaTop);
                    document.documentElement.style.setProperty('--safe-area-bottom', safeAreaBottom);
                };

                updateSafeArea();
                window.addEventListener('resize', updateSafeArea);

                // PWA æ”¯æŒæ£€æµ‹
                if ('serviceWorker' in navigator) {
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  Service Worker æ³¨å†Œ
                }

                // ç½‘ç»œçŠ¶æ€ç›‘æ§
                const handleNetworkChange = () => {
                    if (navigator.onLine) {
                        this.updateConnectionStatus('connected', 'å·²è¿æ¥');
                    } else {
                        this.updateConnectionStatus('disconnected', 'ç½‘ç»œæ–­å¼€');
                    }
                };

                window.addEventListener('online', handleNetworkChange);
                window.addEventListener('offline', handleNetworkChange);

                // ç”µæ± çŠ¶æ€ç›‘æ§ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if ('getBattery' in navigator) {
                    navigator.getBattery().then((battery) => {
                        const updateBatteryInfo = () => {
                            if (battery.level < 0.1 && !battery.charging) {
                                // ä½ç”µé‡æ—¶å‡å°‘åŠ¨ç”»å’Œç‰¹æ•ˆ
                                document.body.classList.add('low-battery');
                            } else {
                                document.body.classList.remove('low-battery');
                            }
                        };

                        battery.addEventListener('levelchange', updateBatteryInfo);
                        battery.addEventListener('chargingchange', updateBatteryInfo);
                        updateBatteryInfo();
                    });
                }

                // å†…å­˜å‹åŠ›æ£€æµ‹ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if ('memory' in performance) {
                    const checkMemory = () => {
                        const memInfo = performance.memory;
                        const usedPercent = memInfo.usedJSHeapSize / memInfo.jsHeapSizeLimit;

                        if (usedPercent > 0.8) {
                            // å†…å­˜ä½¿ç”¨ç‡é«˜æ—¶æ¸…ç†ä¸€äº›ç¼“å­˜
                            console.warn('å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜ï¼Œæ­£åœ¨ä¼˜åŒ–...');
                        }
                    };

                    setInterval(checkMemory, 30000);
                }
            }

            toggleSidebar() {
                this.sidebarVisible = !this.sidebarVisible;
                const sidebar = this.elements.sidebar;

                if (this.sidebarVisible) {
                    sidebar.classList.add('show');
                } else {
                    sidebar.classList.remove('show');
                }
            }
        }

        let chatClient;
        window.addEventListener('DOMContentLoaded', () => {
            chatClient = new ChatClient();
        });
    </script>
</body>
</html>
