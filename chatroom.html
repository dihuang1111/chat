
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>匿名聊天室</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .chat-container {
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }

        .admin-badge.show {
            display: block;
        }

        .online-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .ip-display {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .connection-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.3);
        }

        .connection-status.connecting {
            background: rgba(241, 196, 15, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.3);
        }

        .chat-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
            word-wrap: break-word;
        }

        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.other {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .message.system {
            align-self: center;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-style: italic;
            font-size: 0.9rem;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .username {
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .username:hover {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .admin-info {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-left: 10px;
            display: none;
        }

        .admin-info.show {
            display: inline-block;
        }

        .timestamp {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .sidebar.show {
            display: block;
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-item.current-user {
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .user-details {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .user-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .user-status.offline {
            background: #e74c3c;
        }

        .chat-input {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .message-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn, .admin-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .send-btn:hover, .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .send-btn:disabled, .admin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .admin-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid #667eea;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .user-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-detail-item {
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .user-detail-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .user-detail-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .user-detail-value {
            color: #666;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .kick-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        .kick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .admin-config {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #ff8c00;
        }

        .admin-config strong {
            color: #d2691e;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 全球手机设备完美自适应样式 */

        /* 基础移动端适配 - 包含所有手机 */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }

            .chat-container {
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* 动态视口高度 */
                border-radius: 0;
                max-width: none;
                position: fixed;
                top: 0;
                left: 0;
            }

            .chat-header {
                padding: env(safe-area-inset-top, 10px) 15px 10px 15px;
                flex-wrap: wrap;
                gap: 8px;
                min-height: 60px;
            }

            .chat-title {
                font-size: clamp(1rem, 4vw, 1.3rem);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .user-info {
                flex-wrap: wrap;
                gap: 6px;
                font-size: clamp(0.7rem, 2.5vw, 0.85rem);
                width: 100%;
                justify-content: space-between;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 4px 8px;
                font-size: clamp(0.65rem, 2vw, 0.75rem);
                border-radius: 12px;
                white-space: nowrap;
            }

            .chat-main {
                height: calc(100vh - 140px);
                height: calc(100dvh - 140px);
            }

            .chat-messages {
                padding: 10px;
                gap: 8px;
                height: 100%;
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }

            .message {
                max-width: 85%;
                padding: 10px 14px;
                font-size: clamp(0.85rem, 3.5vw, 1rem);
                border-radius: 16px;
                word-break: break-word;
                hyphens: auto;
            }

            .message-header {
                font-size: clamp(0.7rem, 2.8vw, 0.8rem);
                margin-bottom: 4px;
            }

            .timestamp {
                font-size: clamp(0.6rem, 2.2vw, 0.7rem);
            }

            .sidebar {
                width: 100vw;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                height: 100dvh;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
                padding: env(safe-area-inset-top, 20px) 15px env(safe-area-inset-bottom, 20px) 15px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar h3 {
                font-size: clamp(1rem, 4vw, 1.2rem);
                margin-bottom: 15px;
                color: white;
            }

            .user-item {
                padding: 12px;
                font-size: clamp(0.8rem, 3.2vw, 0.9rem);
                margin-bottom: 8px;
                min-height: 48px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .chat-input {
                padding: 10px 15px env(safe-area-inset-bottom, 10px) 15px;
                background: rgba(255, 255, 255, 0.1);
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            .input-container {
                gap: 8px;
                flex-wrap: nowrap;
                align-items: stretch;
            }

            .message-input {
                flex: 1;
                min-width: 0;
                padding: 12px 16px;
                font-size: clamp(0.9rem, 3.8vw, 1rem);
                border-radius: 20px;
                border: none;
                outline: none;
                min-height: 44px;
            }

            .send-btn, .admin-btn {
                padding: 12px 16px;
                font-size: clamp(0.8rem, 3.2vw, 0.9rem);
                min-width: 80px;
                min-height: 44px;
                border-radius: 20px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .modal {
                z-index: 2000;
            }

            .modal-content {
                width: calc(100vw - 20px);
                max-width: none;
                margin: 10px;
                padding: 20px;
                max-height: calc(100vh - 40px);
                max-height: calc(100dvh - 40px);
                border-radius: 15px;
            }

            .user-detail-section {
                margin-bottom: 15px;
                padding: 12px;
            }

            .section-title {
                font-size: clamp(0.9rem, 3.5vw, 1rem);
            }

            .user-detail-item {
                margin-bottom: 10px;
                padding: 10px;
            }

            .user-detail-label {
                font-size: clamp(0.75rem, 3vw, 0.85rem);
            }

            .user-detail-value {
                font-size: clamp(0.7rem, 2.8vw, 0.8rem);
                padding: 6px;
            }
        }

        /* 超小屏幕适配 (小于480px) */
        @media screen and (max-width: 480px) {
            .chat-header {
                padding: env(safe-area-inset-top, 8px) 10px 8px 10px;
                min-height: 55px;
            }

            .chat-title {
                font-size: clamp(0.9rem, 4.5vw, 1.1rem);
            }

            .user-info {
                font-size: clamp(0.65rem, 2.8vw, 0.75rem);
                gap: 4px;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 3px 6px;
                font-size: clamp(0.6rem, 2.2vw, 0.7rem);
            }

            .chat-messages {
                padding: 8px;
                gap: 6px;
            }

            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: clamp(0.8rem, 3.8vw, 0.95rem);
            }

            .input-container {
                flex-direction: column;
                gap: 6px;
            }

            .message-input {
                width: 100%;
                margin-bottom: 0;
                min-height: 42px;
            }

            .send-btn, .admin-btn {
                width: 100%;
                margin-bottom: 0;
                min-height: 42px;
            }
        }

        /* 超大屏手机适配 (iPhone Pro Max, 大屏Android等) */
        @media screen and (min-width: 414px) and (max-width: 768px) {
            .message {
                max-width: 80%;
                font-size: clamp(0.9rem, 3vw, 1.1rem);
            }

            .chat-header {
                min-height: 65px;
            }

            .user-info {
                font-size: clamp(0.8rem, 2.2vw, 0.9rem);
            }
        }

        /* 横屏手机适配 - 覆盖所有横屏情况 */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .chat-container {
                height: 100vh;
                height: 100dvh;
            }

            .chat-header {
                padding: 5px 15px;
                min-height: 45px;
            }

            .chat-title {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
            }

            .user-info {
                font-size: clamp(0.7rem, 2vw, 0.8rem);
                gap: 4px;
            }

            .admin-badge, .online-count, .ip-display, .connection-status {
                padding: 2px 6px;
                font-size: clamp(0.6rem, 1.8vw, 0.7rem);
            }

            .chat-main {
                height: calc(100vh - 100px);
                height: calc(100dvh - 100px);
            }

            .chat-messages {
                padding: 6px 15px;
            }

            .chat-input {
                padding: 6px 15px;
            }

            .message-input {
                padding: 8px 12px;
                min-height: 36px;
            }

            .send-btn, .admin-btn {
                padding: 8px 12px;
                min-height: 36px;
                font-size: clamp(0.75rem, 2.5vw, 0.85rem);
            }
        }

        /* 特殊屏幕比例适配 (21:9, 18:9等) */
        @media screen and (min-aspect-ratio: 2/1) {
            .chat-header {
                padding: 8px 20px;
            }

            .sidebar {
                width: 50vw;
                max-width: 400px;
            }
        }

        /* 触摸设备优化 - 确保所有触摸元素足够大 */
        @media (hover: none) and (pointer: coarse) {
            .user-item {
                min-height: 48px;
                display: flex;
                align-items: center;
                padding: 12px;
                touch-action: manipulation;
            }

            .send-btn, .admin-btn {
                min-height: 48px;
                min-width: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .message-input {
                min-height: 48px;
                touch-action: manipulation;
            }

            .username {
                min-height: 28px;
                display: inline-block;
                line-height: 28px;
                touch-action: manipulation;
            }

            .close-btn {
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            /* 增加点击区域 */
            .user-item::before {
                content: '';
                position: absolute;
                top: -5px;
                left: -5px;
                right: -5px;
                bottom: -5px;
                z-index: -1;
            }
        }

        /* 高DPI屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .message {
                border: 0.5px solid rgba(255, 255, 255, 0.1);
            }

            .chat-container {
                border: 0.5px solid rgba(255, 255, 255, 0.2);
            }
        }

        /* 无障碍适配 - 支持系统字体大小设置 */
        @media (prefers-reduced-motion: reduce) {
            .sidebar {
                transition: none;
            }

            .message {
                animation: none;
            }

            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item:active {
            background-color: #e0e0e0;
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10001;
            font-size: 14px;
            animation: copyNotification 3s ease-in-out;
        }

        @keyframes copyNotification {
            0% { opacity: 0; transform: translateX(100%); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }

        /* 系统深色模式适配 */
        @media (prefers-color-scheme: dark) {
            .message.other {
                background: rgba(40, 40, 40, 0.9);
                color: #e0e0e0;
            }

            .modal-content {
                background: #2a2a2a;
                color: #e0e0e0;
            }

            .context-menu {
                background: #2a2a2a;
                border-color: #444;
            }

            .context-menu-item {
                color: #e0e0e0;
            }

            .context-menu-item:hover {
                background-color: #404040;
            }
        }

        /* 防止缩放的额外保护 */
        @media screen {
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
                touch-action: pan-x pan-y;
            }

            body {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                overscroll-behavior: none;
            }

            .message-input {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">匿名聊天室</div>
            <div class="user-info">
                <span class="admin-badge" id="adminBadge">管理员</span>
                <span class="ip-display" id="ipDisplay">IP: 获取中...</span>
                <span class="online-count">在线: <span id="onlineCount">0</span></span>
                <span class="connection-status disconnected" id="connectionStatus">未连接</span>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="loading">正在连接服务器...</div>
            </div>

            <div class="sidebar" id="sidebar">
                <h3>在线用户管理</h3>
                <ul class="user-list" id="userList"></ul>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="输入消息..." maxlength="500" disabled>
                <button class="send-btn" id="sendBtn" disabled>发送</button>
                <button class="admin-btn" id="adminBtn">管理面板</button>
            </div>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>用户详细信息</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="userDetails"></div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" id="copyMessage">📋 复制消息</button>
        <button class="context-menu-item" id="copyUsername">👤 复制用户名</button>
        <button class="context-menu-item" id="copyTime">🕒 复制时间</button>
    </div>

    <script>
        class ChatClient {
            constructor() {
                this.ws = null;
                this.currentUser = null;
                this.users = new Map();
                this.isAdmin = false;
                this.roomId = 'default-room';
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.sidebarVisible = false;
                this.realIP = null;
                this.detectedIPs = [];

                this.initElements();
                this.detectAllIPs();
                this.connect();
                this.bindEvents();
            }

            async detectAllIPs() {
                this.detectedIPs = [];

                // 检测外网IP
                try {
                    const ipServices = [
                        { url: 'https://api.ipify.org?format=json', key: 'ip' },
                        { url: 'https://httpbin.org/ip', key: 'origin' },
                        { url: 'https://api.ip.sb/ip', key: null },
                        { url: 'https://ipapi.co/ip/', key: null }
                    ];

                    for (const service of ipServices) {
                        try {
                            const response = await fetch(service.url);
                            let ip;

                            if (service.key) {
                                const data = await response.json();
                                ip = service.key === 'origin' ? data[service.key].split(',')[0].trim() : data[service.key];
                            } else {
                                ip = (await response.text()).trim();
                            }

                            if (ip && this.isValidIP(ip) && !this.detectedIPs.includes(ip)) {
                                this.detectedIPs.push(ip);
                            }
                        } catch (e) {
                            console.warn(`IP服务失败:`, e);
                        }
                    }
                } catch (error) {
                    console.error('外网IP检测失败:', error);
                }

                // 检测内网IP
                try {
                    const localIPs = await this.getLocalIPs();
                    localIPs.forEach(ip => {
                        if (!this.detectedIPs.includes(ip)) {
                            this.detectedIPs.push(ip);
                        }
                    });
                } catch (error) {
                    console.error('内网IP检测失败:', error);
                }

                // 添加常见的本地IP
                const commonLocalIPs = ['127.0.0.1', '::1', 'localhost'];
                commonLocalIPs.forEach(ip => {
                    if (!this.detectedIPs.includes(ip)) {
                        this.detectedIPs.push(ip);
                    }
                });

                this.realIP = this.detectedIPs[0] || '未知';
                console.log('检测到的所有IP地址:', this.detectedIPs);
            }

            isValidIP(ip) {
                const ipv4Regex = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/;
                const ipv6Regex = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
                return ipv4Regex.test(ip) || ipv6Regex.test(ip);
            }

            async getLocalIPs() {
                return new Promise((resolve) => {
                    const ips = [];
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });

                    pc.createDataChannel('');
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                            if (ipMatch && !ips.includes(ipMatch[1])) {
                                ips.push(ipMatch[1]);
                            }
                        }
                    };

                    pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    setTimeout(() => {
                        pc.close();
                        resolve(ips);
                    }, 3000);
                });
            }

            initElements() {
                this.elements = {
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    adminBtn: document.getElementById('adminBtn'),
                    adminBadge: document.getElementById('adminBadge'),
                    onlineCount: document.getElementById('onlineCount'),
                    ipDisplay: document.getElementById('ipDisplay'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    sidebar: document.getElementById('sidebar'),
                    userList: document.getElementById('userList'),
                    userModal: document.getElementById('userModal'),
                    closeModal: document.getElementById('closeModal'),
                    userDetails: document.getElementById('userDetails')
                };
            }

            connect() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}`;

                    console.log('连接到WebSocket服务器:', wsUrl);
                    this.ws = new WebSocket(wsUrl);
                    this.updateConnectionStatus('connecting', '连接中...');

                    this.ws.onopen = () => {
                        console.log('WebSocket连接已建立');
                        this.updateConnectionStatus('connected', '已连接');
                        this.reconnectAttempts = 0;
                        this.reconnectDelay = 1000;
                        this.joinRoom();
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('消息解析错误:', error);
                        }
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocket连接已关闭', event.code, event.reason);
                        this.updateConnectionStatus('disconnected', '连接断开');
                        this.disableChat();
                        this.attemptReconnect();
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                        this.updateConnectionStatus('disconnected', '连接错误');
                    };

                } catch (error) {
                    console.error('连接失败:', error);
                    this.updateConnectionStatus('disconnected', '连接失败');
                    this.attemptReconnect();
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`尝试重连 ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);

                    this.updateConnectionStatus('connecting', `重连中... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay);

                    this.reconnectDelay = Math.min(this.reconnectDelay * 1.5, 10000);
                } else {
                    console.log('重连失败，请刷新页面');
                    this.addSystemMessage('连接失败，请刷新页面重试');
                    this.updateConnectionStatus('disconnected', '连接失败，请刷新页面');
                }
            }

            updateConnectionStatus(status, text) {
                this.elements.connectionStatus.className = `connection-status ${status}`;
                this.elements.connectionStatus.textContent = text;
            }

            joinRoom() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'joinRoom',
                        roomId: this.roomId
                    }));
                }
            }

            enableChat() {
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
                this.elements.messageInput.focus();
            }

            disableChat() {
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'userInit':
                        this.handleUserInit(data.user);
                        break;
                    case 'joinedRoom':
                        this.handleJoinedRoom(data);
                        break;
                    case 'userList':
                        this.handleUserList(data.users, data.onlineCount);
                        break;
                    case 'userJoined':
                        this.handleUserJoined(data.user);
                        break;
                    case 'userLeft':
                        this.handleUserLeft(data.user);
                        break;
                    case 'newMessage':
                        this.handleNewMessage(data.message);
                        break;
                    case 'systemMessage':
                        this.addSystemMessage(data.message);
                        break;
                    case 'userDetails':
                        this.showUserDetails(data.user);
                        break;
                    case 'kicked':
                        alert(data.message);
                        window.location.reload();
                        break;
                    case 'error':
                        console.error('服务器错误:', data.message);
                        this.addSystemMessage('错误: ' + data.message);
                        break;
                    case 'ping':
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({ type: 'heartbeat' }));
                        }
                        break;
                    case 'pong':
                        break;

                    case 'userDetectionUpdate':
                        this.handleUserDetectionUpdate(data);
                        break;
                }
            }

            handleUserInit(user) {
                this.currentUser = user;
                this.isAdmin = user.isAdmin;

                // 显示所有检测到的IP
                const ipDisplayText = this.detectedIPs.length > 0 ? 
                    `IP: ${this.detectedIPs.join(', ')}` : 
                    `IP: ${user.ip}`;
                this.elements.ipDisplay.textContent = ipDisplayText;

                if (this.isAdmin) {
                    this.elements.adminBadge.classList.add('show');
                } else {
                    // 显示管理员权限配置提示
                    this.addAdminConfigMessage();
                }

                this.clearMessages();
                this.addSystemMessage(`欢迎 ${user.username}！${this.isAdmin ? '您具有管理员权限。' : ''}`);
                this.enableChat();
            }

            addAdminConfigMessage() {
                const chatMessages = this.elements.chatMessages;
                const configDiv = document.createElement('div');
                configDiv.className = 'admin-config';
                configDiv.innerHTML = `
                    <strong>🔧 管理员权限配置提示：</strong><br>
                    检测到您的IP地址：<code>${this.detectedIPs.join(', ')}</code><br>
                    如需获得管理员权限，请在服务器的 <code>adminIPs</code> 数组中添加您的IP地址。<br>
                    <strong>注意：</strong>如果您使用的是动态IP或通过代理访问，IP地址可能会变化。
                `;
                chatMessages.appendChild(configDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            handleJoinedRoom(data) {
                if (data.success) {
                    this.addSystemMessage(`已加入房间：${data.roomId}`);
                }
            }

            handleUserList(users, onlineCount) {
                this.users.clear();
                users.forEach(user => this.users.set(user.id, user));

                this.elements.onlineCount.textContent = onlineCount;
                this.updateUserList();
            }

            handleUserJoined(user) {
                this.users.set(user.id, user);
                this.updateUserList();
                this.addSystemMessage(`${user.username} 加入了聊天室`);
            }

            handleUserLeft(user) {
                this.users.delete(user.id);
                this.updateUserList();
                this.addSystemMessage(`${user.username} 离开了聊天室`);
            }

            handleNewMessage(message) {
                const isOwn = message.sender.id === this.currentUser.id;
                this.addMessage(message, isOwn);
            }

            updateUserList() {
                const userList = this.elements.userList;
                userList.innerHTML = '';

                this.users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    if (user.id === this.currentUser.id) {
                        li.classList.add('current-user');
                    }

                    li.innerHTML = `
                        <div class="username">${user.username}</div>
                        <div class="user-details">
                            ${user.isAdmin ? '<span style="color: #ff6b6b;">👑 管理员</span>' : ''}
                            ${user.ip && !user.isAdmin ? `<br>IP: ${user.ip}` : ''}
                            ${user.joinTime ? `<br>加入: ${new Date(user.joinTime).toLocaleTimeString()}` : ''}
                        </div>
                        <div class="user-status ${user.isOnline ? '' : 'offline'}"></div>
                    `;

                    if (this.isAdmin && user.id !== this.currentUser.id) {
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            this.getUserDetails(user.id);
                        });
                    }

                    userList.appendChild(li);
                });

                const onlineUsers = Array.from(this.users.values()).filter(u => u.isOnline !== false);
                this.elements.onlineCount.textContent = onlineUsers.length;
            }

            addMessage(message, isOwn = false) {
                const messagesContainer = this.elements.chatMessages;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;

                const time = new Date(message.timestamp).toLocaleTimeString();
                const adminMark = message.sender.isAdmin ? '<span class="admin-info show">👑</span>' : '';

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username">${message.sender.username}${adminMark}</span>
                        <span class="timestamp">${time}</span>
                    </div>
                    <div class="message-content">${this.escapeHtml(message.text)}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const loadingMsg = messagesContainer.querySelector('.loading');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
            }

            addSystemMessage(text) {
                const messagesContainer = this.elements.chatMessages;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="message-content">${this.escapeHtml(text)}</div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const loadingMsg = messagesContainer.querySelector('.loading');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
            }

            clearMessages() {
                this.elements.chatMessages.innerHTML = '';
            }

            sendMessage() {
                const input = this.elements.messageInput;
                const text = input.value.trim();

                if (!text || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    return;
                }

                this.ws.send(JSON.stringify({
                    type: 'sendMessage',
                    text: text
                }));

                input.value = '';
                input.focus();
            }

            getUserDetails(userId) {
                if (!this.isAdmin) return;

                this.ws.send(JSON.stringify({
                    type: 'getUserDetails',
                    targetUserId: userId
                }));
            }

            handleUserDetectionUpdate(data) {
                // 更新用户详情窗口中的检测结果
                if (this.elements.userModal.style.display === 'block') {
                    this.updateDetectionResults(data.targetUserId, data);
                }
            }

            updateDetectionResults(userId, data) {
                // 更新服务器端Tor检测结果
                const torElement = document.getElementById(`server-tor-status-${userId}`);
                if (torElement && data.torDetection) {
                    this.displayServerTorResults(userId, data.torDetection);
                }

                // 更新服务器端IP信息
                const ipInfoElement = document.getElementById(`server-ip-info-${userId}`);
                if (ipInfoElement && data.ipInfo) {
                    this.displayServerIPInfo(userId, data.ipInfo);
                }

                // 如果检测正在进行，显示加载状态
                if (data.detectionInProgress) {
                    const loadingElement = document.getElementById(`server-detection-loading-${userId}`);
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }
                }
            }

            showUserDetails(user) {
                const content = this.elements.userDetails;
                const browserInfo = this.getBrowserInfo(user.userAgent);
                const osInfo = this.getOSInfo(user.userAgent);

                // 获取更详细的浏览器和系统信息
                const detailedBrowserInfo = this.getDetailedBrowserInfo(user.userAgent);
                const screenInfo = this.getScreenInfo();
                const languageInfo = this.getLanguageInfo();
                const timezoneInfo = this.getTimezoneInfo();
                const hardwareInfo = this.getHardwareInfo();
                const networkInfo = this.getNetworkInfo();
                const securityInfo = this.getSecurityInfo();

                // 开始WebRTC IP检测
                this.detectWebRTCIPs(user.id);

                // 请求服务器端检测结果
                this.requestServerDetection(user.id);

                content.innerHTML = `
                    <div class="user-detail-section">
                        <div class="section-title">📋 基本信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">用户ID</div>
                            <div class="user-detail-value">${user.id}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">用户名</div>
                            <div class="user-detail-value">${user.username}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">服务器检测IP</div>
                            <div class="user-detail-value">${user.ip || '未知IP地址'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">权限等级</div>
                            <div class="user-detail-value">${user.isAdmin ? '👑 管理员' : '👤 普通用户'}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🧅 服务器端网络检测</div>
                        <div id="server-detection-loading-${user.id}" style="display: ${user.detectionInProgress ? 'block' : 'none'};">
                            <div class="user-detail-item">
                                <div class="user-detail-label">🔍 检测状态</div>
                                <div class="user-detail-value">⏳ 服务器正在检测中，请稍候...</div>
                            </div>
                        </div>
                        <div id="server-tor-status-${user.id}">
                            ${this.generateServerTorStatus(user)}
                        </div>
                        <div id="server-ip-info-${user.id}">
                            ${this.generateServerIPInfo(user)}
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">📍 IP地址 (WebRTC)</div>
                        <div id="webrtc-ip-loading-${user.id}" class="user-detail-item">
                            <div class="user-detail-label">WebRTC检测状态</div>
                            <div class="user-detail-value">🔍 正在检测真实IP地址...</div>
                        </div>
                        <div id="webrtc-ip-results-${user.id}" style="display: none;"></div>
                        <div id="webrtc-ip-no-results-${user.id}" style="display: none;" class="user-detail-item">
                            <div class="user-detail-label">WebRTC检测结果</div>
                            <div class="user-detail-value">⚠️ 未找到IP地址。这可能是由于您的浏览器设置、网络配置（例如广告拦截器、防火墙或禁用了WebRTC）所致。</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🌐 浏览器信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">浏览器</div>
                            <div class="user-detail-value">${detailedBrowserInfo.name} ${detailedBrowserInfo.version}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">浏览器内核</div>
                            <div class="user-detail-value">${detailedBrowserInfo.engine}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">操作系统</div>
                            <div class="user-detail-value">${osInfo}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">设备类型</div>
                            <div class="user-detail-value">${detailedBrowserInfo.deviceType}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">User Agent</div>
                            <div class="user-detail-value" style="word-break: break-all; font-size: 0.8em;">${user.userAgent || '未知'}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🖥️ 显示信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">屏幕分辨率</div>
                            <div class="user-detail-value">${screenInfo.resolution}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">可用屏幕大小</div>
                            <div class="user-detail-value">${screenInfo.availableSize}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">色彩深度</div>
                            <div class="user-detail-value">${screenInfo.colorDepth} 位</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">像素比</div>
                            <div class="user-detail-value">${screenInfo.pixelRatio}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🌍 地区信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">时区</div>
                            <div class="user-detail-value">${timezoneInfo.timezone}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">时区偏移</div>
                            <div class="user-detail-value">${timezoneInfo.offset}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">语言</div>
                            <div class="user-detail-value">${languageInfo.language}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">语言列表</div>
                            <div class="user-detail-value">${languageInfo.languages}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">⚙️ 硬件信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">CPU核心数</div>
                            <div class="user-detail-value">${hardwareInfo.cores}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">内存大小</div>
                            <div class="user-detail-value">${hardwareInfo.memory}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">GPU信息</div>
                            <div class="user-detail-value">${hardwareInfo.gpu}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">电池状态</div>
                            <div class="user-detail-value">${hardwareInfo.battery}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🌐 网络信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">连接类型</div>
                            <div class="user-detail-value">${networkInfo.type}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">下行带宽</div>
                            <div class="user-detail-value">${networkInfo.downlink}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">网络延迟</div>
                            <div class="user-detail-value">${networkInfo.rtt}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">数据节省模式</div>
                            <div class="user-detail-value">${networkInfo.saveData}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">🔒 安全信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">Cookie 启用</div>
                            <div class="user-detail-value">${securityInfo.cookieEnabled}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">DoNotTrack</div>
                            <div class="user-detail-value">${securityInfo.doNotTrack}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">Java 启用</div>
                            <div class="user-detail-value">${securityInfo.javaEnabled}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">WebGL支持</div>
                            <div class="user-detail-value">${securityInfo.webglSupport}</div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <div class="section-title">⏰ 活动信息</div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">加入时间</div>
                            <div class="user-detail-value">${user.joinTime ? new Date(user.joinTime).toLocaleString() : '未知'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">最后活动</div>
                            <div class="user-detail-value">${user.lastActivity ? new Date(user.lastActivity).toLocaleString() : '未知'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">在线状态</div>
                            <div class="user-detail-value">${user.isOnline ? '🟢 在线' : '🔴 离线'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">房间ID</div>
                            <div class="user-detail-value">${user.roomId || '未知'}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">在线时长</div>
                            <div class="user-detail-value">${this.getOnlineTime(user.joinTime)}</div>
                        </div>
                    </div>

                    ${!user.isAdmin ? `
                    <div class="user-detail-section">
                        <div class="section-title">⚡ 管理操作</div>
                        <button class="kick-btn" onclick="chatClient.kickUser('${user.id}')">🚫 踢出用户</button>
                    </div>
                    ` : ''}
                `;

                this.elements.userModal.style.display = 'block';
            }

            getDetailedBrowserInfo(userAgent) {
                const info = { name: '未知', version: '未知', engine: '未知', deviceType: '桌面' };

                if (userAgent.includes('Edg/')) {
                    info.name = 'Microsoft Edge';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Edg\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Chrome/')) {
                    info.name = 'Google Chrome';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Chrome\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Firefox/')) {
                    info.name = 'Mozilla Firefox';
                    info.engine = 'Gecko';
                    const match = userAgent.match(/Firefox\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Safari/')) {
                    info.name = 'Safari';
                    info.engine = 'WebKit';
                    const match = userAgent.match(/Version\/(\d+)/);
                    if (match) info.version = match[1];
                } else if (userAgent.includes('Opera/')) {
                    info.name = 'Opera';
                    info.engine = 'Blink';
                    const match = userAgent.match(/Opera\/(\d+)/);
                    if (match) info.version = match[1];
                }

                // 检测设备类型
                if (userAgent.includes('Mobile')) {
                    info.deviceType = '移动设备';
                } else if (userAgent.includes('Tablet')) {
                    info.deviceType = '平板电脑';
                } else {
                    info.deviceType = '桌面电脑';
                }

                return info;
            }

            getScreenInfo() {
                return {
                    resolution: `${screen.width} × ${screen.height}`,
                    availableSize: `${screen.availWidth} × ${screen.availHeight}`,
                    colorDepth: screen.colorDepth,
                    pixelRatio: window.devicePixelRatio || 1
                };
            }

            getLanguageInfo() {
                return {
                    language: navigator.language || '未知',
                    languages: navigator.languages ? navigator.languages.join(', ') : '未知'
                };
            }

            getTimezoneInfo() {
                const now = new Date();
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const offset = -now.getTimezoneOffset();
                const offsetHours = Math.floor(offset / 60);
                const offsetMinutes = offset % 60;
                const offsetString = `UTC${offset >= 0 ? '+' : ''}${offsetHours}:${offsetMinutes.toString().padStart(2, '0')}`;

                return {
                    timezone: timezone,
                    offset: offsetString
                };
            }

            getHardwareInfo() {
                return {
                    cores: navigator.hardwareConcurrency || '未知',
                    memory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : '未知',
                    gpu: this.getGPUInfo(),
                    battery: this.getBatteryInfo()
                };
            }

            getGPUInfo() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        if (debugInfo) {
                            const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                            const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                            return `${vendor} - ${renderer}`;
                        }
                    }
                    return '未知';
                } catch (e) {
                    return '无法获取';
                }
            }

            getBatteryInfo() {
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        const level = Math.round(battery.level * 100);
                        const charging = battery.charging ? '充电中' : '未充电';
                        return `${level}% (${charging})`;
                    });
                    return '检测中...';
                }
                return '不支持电池检测';
            }

            getNetworkInfo() {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (connection) {
                    return {
                        type: connection.effectiveType || connection.type || '未知',
                        downlink: connection.downlink ? `${connection.downlink} Mbps` : '未知',
                        rtt: connection.rtt ? `${connection.rtt} ms` : '未知',
                        saveData: connection.saveData ? '启用' : '未启用'
                    };
                }
                return { type: '未知', downlink: '未知', rtt: '未知', saveData: '未知' };
            }

            getSecurityInfo() {
                return {
                    cookieEnabled: navigator.cookieEnabled ? '✅ 启用' : '❌ 禁用',
                    doNotTrack: navigator.doNotTrack === '1' ? '启用' : '未启用',
                    javaEnabled: navigator.javaEnabled ? (navigator.javaEnabled() ? '✅ 启用' : '❌ 禁用') : '❌ 不支持',
                    webglSupport: this.checkWebGLSupport()
                };
            }

            checkWebGLSupport() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    return gl ? '✅ 支持' : '❌ 不支持';
                } catch (e) {
                    return '❌ 不支持';
                }
            }

            getOnlineTime(joinTime) {
                if (!joinTime) return '未知';

                const now = new Date();
                const start = new Date(joinTime);
                const diff = now - start;

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                if (hours > 0) {
                    return `${hours}小时${minutes}分钟`;
                } else if (minutes > 0) {
                    return `${minutes}分钟${seconds}秒`;
                } else {
                    return `${seconds}秒`;
                }
            }

            requestServerDetection(userId) {
                if (!this.isAdmin) return;

                this.ws.send(JSON.stringify({
                    type: 'requestDetection',
                    targetUserId: userId
                }));
            }

            generateServerTorStatus(user) {
                if (user.torDetection) {
                    return this.formatServerTorResults(user.id, user.torDetection);
                } else if (user.detectionInProgress) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🧅 服务器端Tor检测</div>
                            <div class="user-detail-value">🔍 服务器正在检测...</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🧅 服务器端Tor检测</div>
                            <div class="user-detail-value">⏳ 等待服务器检测结果...</div>
                        </div>
                    `;
                }
            }

            generateServerIPInfo(user) {
                if (user.ipInfo && user.ipInfo.success) {
                    return this.formatServerIPInfo(user.id, user.ipInfo);
                } else if (user.detectionInProgress) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🌍 服务器端IP信息</div>
                            <div class="user-detail-value">🔍 服务器正在获取...</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🌍 服务器端IP信息</div>
                            <div class="user-detail-value">⏳ 等待服务器获取结果...</div>
                        </div>
                    `;
                }
            }

            displayServerTorResults(userId, torDetection) {
                const element = document.getElementById(`server-tor-status-${userId}`);
                if (element) {
                    element.innerHTML = this.formatServerTorResults(userId, torDetection);
                }

                // 隐藏加载指示器
                const loading = document.getElementById(`server-detection-loading-${userId}`);
                if (loading) {
                    loading.style.display = 'none';
                }
            }

            formatServerTorResults(userId, torDetection) {
                const resultStatus = torDetection.isTor ? 
                    `🧅 <span style="color: #ff6b6b; font-weight: bold;">服务器确认: 正在使用Tor网络</span>` :
                    `🌐 <span style="color: #2ecc71; font-weight: bold;">服务器确认: 未使用Tor网络</span>`;

                let html = `
                    <div class="user-detail-item">
                        <div class="user-detail-label">🧅 服务器端Tor检测</div>
                        <div class="user-detail-value">${resultStatus}</div>
                    </div>
                `;

                if (torDetection.torExitNode) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🚪 Tor出口节点</div>
                            <div class="user-detail-value">✅ <span style="color: #ff6b6b;">确认为Tor出口节点</span></div>
                        </div>
                    `;
                }

                html += `
                    <div class="user-detail-item">
                        <div class="user-detail-label">📋 服务器检测详情</div>
                        <div class="user-detail-value">
                            ${torDetection.detectionDetails.map(detail => `• ${detail}`).join('<br>')}<br>
                            <small style="color: #666;">检测时间: ${new Date().toLocaleString()}</small>
                        </div>
                    </div>
                `;

                if (torDetection.error) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">⚠️ 检测错误</div>
                            <div class="user-detail-value" style="color: #e74c3c;">${torDetection.error}</div>
                        </div>
                    `;
                }

                return html;
            }

            displayServerIPInfo(userId, ipInfo) {
                const element = document.getElementById(`server-ip-info-${userId}`);
                if (element) {
                    element.innerHTML = this.formatServerIPInfo(userId, ipInfo);
                }
            }

            formatServerIPInfo(userId, ipInfo) {
                if (!ipInfo.success) {
                    return `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🌍 服务器端IP信息</div>
                            <div class="user-detail-value">❌ 获取失败: ${ipInfo.error}</div>
                        </div>
                    `;
                }

                const data = ipInfo.data;
                let html = `
                    <div class="user-detail-item">
                        <div class="user-detail-label">🌍 IP信息来源</div>
                        <div class="user-detail-value">✅ ${ipInfo.source}</div>
                    </div>
                `;

                // 处理不同服务的数据格式
                if (data.country || data.countryCode) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🌍 地理位置</div>
                            <div class="user-detail-value">
                                ${data.city || data.regionName || '未知'}, ${data.region || data.regionName || '未知'}, ${data.country || '未知'}
                                ${data.countryCode ? ` (${data.countryCode})` : ''}<br>
                                ${data.lat && data.lon ? `<small>经纬度: ${data.lat}, ${data.lon}</small>` : ''}
                                ${data.loc ? `<small>经纬度: ${data.loc}</small>` : ''}
                            </div>
                        </div>
                    `;
                }

                if (data.org || data.isp || data.as) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🏢 ISP信息</div>
                            <div class="user-detail-value">
                                组织: ${data.org || data.isp || data.asname || '未知'}<br>
                                ${data.as ? `AS号: ${data.as}<br>` : ''}
                                ${data.hostname || data.reverse ? `主机名: ${data.hostname || data.reverse}<br>` : ''}
                                ${data.timezone ? `时区: ${data.timezone}` : ''}
                            </div>
                        </div>
                    `;
                }

                if (data.proxy !== undefined || data.hosting !== undefined || data.mobile !== undefined) {
                    html += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🔍 连接特征</div>
                            <div class="user-detail-value">
                                ${data.proxy !== undefined ? `代理: ${data.proxy ? '是' : '否'}<br>` : ''}
                                ${data.hosting !== undefined ? `托管服务: ${data.hosting ? '是' : '否'}<br>` : ''}
                                ${data.mobile !== undefined ? `移动网络: ${data.mobile ? '是' : '否'}` : ''}
                            </div>
                        </div>
                    `;
                }

                return html;
            }

            async detectTorConnection(userId, userIP) {
                // 这个函数现在主要用于客户端检测作为补充
                if (!this.isAdmin || !userIP) return;

                const torElement = document.getElementById(`tor-status-${userId}`);
                if (!torElement) return;

                try {
                    let torDetected = false;
                    let ipInfo = null;
                    let detectionDetails = [];

                    // 方法1: 直接使用Tor Project官方API检测IP
                    try {
                        const torCheckUrl = `https://check.torproject.org/api/ip?ip=${encodeURIComponent(userIP)}`;
                        const torResponse = await fetch(torCheckUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (torResponse.ok) {
                            const torData = await torResponse.json();
                            torDetected = torData.IsTor === true;
                            detectionDetails.push(`Tor官方检测: ${torDetected ? '是Tor节点' : '非Tor节点'}`);
                        }
                    } catch (torError) {
                        console.warn('Tor官方API检测失败:', torError);
                        detectionDetails.push('Tor官方API: 检测失败 (CORS限制)');
                    }

                    // 方法2: 使用IPInfo.io获取详细信息
                    try {
                        const ipinfoUrl = `https://ipinfo.io/${encodeURIComponent(userIP)}/json`;
                        const ipinfoResponse = await fetch(ipinfoUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });

                        if (ipinfoResponse.ok) {
                            ipInfo = await ipinfoResponse.json();

                            // 检查组织信息中是否包含Tor相关关键词
                            const org = (ipInfo.org || '').toLowerCase();
                            const isp = (ipInfo.hostname || '').toLowerCase();
                            const torKeywords = ['tor', 'onion', 'relay', 'exit', 'proxy', 'anonymous', 'privacy'];

                            const hasTorKeywords = torKeywords.some(keyword => 
                                org.includes(keyword) || isp.includes(keyword)
                            );

                            if (hasTorKeywords && !torDetected) {
                                torDetected = true;
                                detectionDetails.push('IPInfo检测: 疑似Tor节点 (基于ISP信息)');
                            } else {
                                detectionDetails.push(`IPInfo检测: ${ipInfo.org || '未知ISP'}`);
                            }
                        }
                    } catch (ipinfoError) {
                        console.warn('IPInfo检测失败:', ipinfoError);
                        detectionDetails.push('IPInfo.io: 检测失败');
                    }

                    // 方法3: 检查Tor出口节点列表
                    if (!torDetected) {
                        try {
                            const exitListResponse = await fetch('https://check.torproject.org/torbulkexitlist', {
                                method: 'GET',
                                mode: 'cors',
                                cache: 'no-cache'
                            });

                            if (exitListResponse.ok) {
                                const exitList = await exitListResponse.text();
                                if (exitList.includes(userIP)) {
                                    torDetected = true;
                                    detectionDetails.push('Tor出口列表: 确认为Tor出口节点');
                                } else {
                                    detectionDetails.push('Tor出口列表: 非出口节点');
                                }
                            }
                        } catch (exitError) {
                            console.warn('Tor出口列表检查失败:', exitError);
                            detectionDetails.push('Tor出口列表: 检测失败');
                        }
                    }

                    // 构建结果显示
                    const resultHtml = torDetected ? 
                        `🧅 <span style="color: #ff6b6b; font-weight: bold;">正在使用Tor网络</span>` :
                        `🌐 <span style="color: #2ecc71; font-weight: bold;">未使用Tor网络</span>`;

                    let detailsHtml = `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🧅 Tor网络状态</div>
                            <div class="user-detail-value">${resultHtml}</div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">🔍 检测目标IP</div>
                            <div class="user-detail-value">${userIP}</div>
                        </div>
                    `;

                    // 显示IPInfo详细信息
                    if (ipInfo) {
                        detailsHtml += `
                            <div class="user-detail-item">
                                <div class="user-detail-label">🌍 地理位置</div>
                                <div class="user-detail-value">
                                    ${ipInfo.city || '未知'}, ${ipInfo.region || '未知'}, ${ipInfo.country || '未知'}<br>
                                    <small>经纬度: ${ipInfo.loc || '未知'}</small>
                                </div>
                            </div>
                            <div class="user-detail-item">
                                <div class="user-detail-label">🏢 ISP信息</div>
                                <div class="user-detail-value">
                                    组织: ${ipInfo.org || '未知'}<br>
                                    主机名: ${ipInfo.hostname || '未知'}<br>
                                    时区: ${ipInfo.timezone || '未知'}
                                </div>
                            </div>
                        `;
                    }

                    // 显示检测详情
                    detailsHtml += `
                        <div class="user-detail-item">
                            <div class="user-detail-label">📋 检测详情</div>
                            <div class="user-detail-value">
                                ${detectionDetails.map(detail => `• ${detail}`).join('<br>')}<br>
                                <small style="color: #666;">检测时间: ${new Date().toLocaleString()}</small>
                            </div>
                        </div>
                    `;

                    torElement.innerHTML = detailsHtml;

                } catch (error) {
                    console.error('Tor检测失败:', error);

                    torElement.innerHTML = `
                        <div class="user-detail-item">
                            <div class="user-detail-label">🧅 Tor网络检测</div>
                            <div class="user-detail-value">
                                ⚠️ <span style="color: #e74c3c;">检测失败</span><br>
                                <small style="color: #666;">
                                    检测IP: ${userIP}<br>
                                    错误: ${error.message}<br>
                                    这可能由于CORS策略、网络限制或API服务异常导致
                                </small>
                            </div>
                        </div>
                        <div class="user-detail-item">
                            <div class="user-detail-label">💡 手动检测链接</div>
                            <div class="user-detail-value">
                                <a href="https://check.torproject.org/api/ip?ip=${encodeURIComponent(userIP)}" target="_blank" style="color: #667eea;">
                                    🧅 Tor官方检测
                                </a><br>
                                <a href="https://ipinfo.io/${encodeURIComponent(userIP)}" target="_blank" style="color: #667eea;">
                                    🌍 IPInfo详情
                                </a>
                            </div>
                        </div>
                    `;
                }
            }

            async heuristicTorDetection() {
                try {
                    // 启发式检测方法：检查常见的Tor特征
                    const checks = [];

                    // 检查1: 时区和语言不匹配（常见的匿名化特征）
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const language = navigator.language;

                    // 检查2: WebRTC是否被禁用（许多Tor用户会禁用WebRTC）
                    const webrtcDisabled = await this.checkWebRTCDisabled();
                    if (webrtcDisabled) checks.push('WebRTC被禁用');

                    // 检查3: 用户代理字符串特征
                    const userAgent = navigator.userAgent;
                    const torBrowserPatterns = [
                        /Firefox\/\d+\.\d+$/,  // Tor浏览器通常基于Firefox且版本号格式特殊
                        /Windows NT 10\.0.*Firefox/  // 特定的Windows+Firefox组合
                    ];

                    const hasTorPattern = torBrowserPatterns.some(pattern => pattern.test(userAgent));
                    if (hasTorPattern) checks.push('疑似Tor浏览器特征');

                    // 检查4: 屏幕分辨率是否为常见的匿名化分辨率
                    const commonTorResolutions = [
                        '1000x700', '1200x800', '1400x900', '1600x900'
                    ];
                    const currentResolution = `${screen.width}x${screen.height}`;
                    if (commonTorResolutions.includes(currentResolution)) {
                        checks.push('使用常见匿名化分辨率');
                    }

                    // 检查5: 插件数量（Tor浏览器通常禁用大部分插件）
                    if (navigator.plugins.length === 0) {
                        checks.push('没有浏览器插件');
                    }

                    console.log('Tor启发式检测结果:', checks);

                    // 如果有3个或以上特征匹配，认为可能是Tor
                    return checks.length >= 3;

                } catch (error) {
                    console.error('启发式Tor检测失败:', error);
                    return false;
                }
            }

            async checkWebRTCDisabled() {
                return new Promise((resolve) => {
                    try {
                        const pc = new RTCPeerConnection();
                        pc.createDataChannel('test');

                        const timeout = setTimeout(() => {
                            pc.close();
                            resolve(true); // 如果超时，认为WebRTC被禁用
                        }, 1000);

                        pc.onicecandidate = (event) => {
                            clearTimeout(timeout);
                            pc.close();
                            resolve(false); // 有ICE候选，WebRTC正常工作
                        };

                        pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    } catch (error) {
                        resolve(true); // 出错认为WebRTC被禁用
                    }
                });
            }

            detectWebRTCIPs(userId) {
                if (!this.isAdmin) return;

                const loadingElement = document.getElementById(`webrtc-ip-loading-${userId}`);
                const resultsElement = document.getElementById(`webrtc-ip-results-${userId}`);
                const noResultsElement = document.getElementById(`webrtc-ip-no-results-${userId}`);

                this.getIPs(userId, async (ip) => {
                    if (ip) {
                        // 隐藏加载状态
                        loadingElement.style.display = 'none';

                        // 创建IP条目
                        const entry = document.createElement('div');
                        entry.className = 'user-detail-item';
                        entry.style.marginBottom = '10px';

                        const header = document.createElement('div');
                        header.style.display = 'flex';
                        header.style.justifyContent = 'space-between';
                        header.style.alignItems = 'center';
                        header.style.marginBottom = '8px';

                        const address = document.createElement('span');
                        address.className = 'user-detail-label';
                        address.textContent = `📍 ${ip}`;

                        const typeSpan = document.createElement('span');
                        typeSpan.style.padding = '2px 8px';
                        typeSpan.style.borderRadius = '12px';
                        typeSpan.style.fontSize = '0.7rem';
                        typeSpan.style.fontWeight = 'bold';

                        header.appendChild(address);
                        header.appendChild(typeSpan);

                        const geo = document.createElement('div');
                        geo.className = 'user-detail-value';
                        geo.textContent = '🔍 正在获取地理位置...';

                        entry.appendChild(header);
                        entry.appendChild(geo);

                        if (resultsElement.style.display === 'none') {
                            resultsElement.innerHTML = '';
                            resultsElement.style.display = 'block';
                        }
                        resultsElement.appendChild(entry);

                        try {
                            const response = await fetch(`https://ipapi.co/${ip}/json/`);
                            const data = await response.json();

                            if (!data.error) {
                                const locationParts = [data.city, data.region, data.country_name].filter(Boolean);
                                const location = locationParts.length > 0 ? locationParts.join(', ') : '地理位置信息不可用';
                                const isp = data.org || 'ISP信息不可用';

                                geo.innerHTML = `
                                    <div style="margin-bottom: 4px;"><strong>📍 位置:</strong> ${location}</div>
                                    <div style="margin-bottom: 4px;"><strong>🏢 ISP:</strong> ${isp}</div>
                                    ${data.timezone ? `<div><strong>🕒 时区:</strong> ${data.timezone}</div>` : ''}
                                `;

                                if (this.isPublicIP(ip)) {
                                    typeSpan.style.background = '#e74c3c';
                                    typeSpan.style.color = 'white';
                                    typeSpan.textContent = data.ip && data.ip.includes(':') ? 'IPv6 公网' : '公网IP';
                                } else {
                                    typeSpan.style.background = '#3498db';
                                    typeSpan.style.color = 'white';
                                    typeSpan.textContent = '内网IP';
                                }
                            } else if (data.reason === 'Reserved IP Address') {
                                geo.innerHTML = '<div><strong>🏠 类型:</strong> 本地网络地址</div>';
                                typeSpan.style.background = '#3498db';
                                typeSpan.style.color = 'white';
                                typeSpan.textContent = '内网IP';
                            } else {
                                geo.innerHTML = '<div><strong>⚠️ 状态:</strong> 地理位置信息不可用</div>';
                                typeSpan.style.background = '#95a5a6';
                                typeSpan.style.color = 'white';
                                typeSpan.textContent = '未知';
                            }
                        } catch (error) {
                            console.error('Geolocation fetch error:', error);
                            geo.innerHTML = '<div><strong>❌ 错误:</strong> 获取地理位置时出错</div>';
                            typeSpan.style.background = '#e67e22';
                            typeSpan.style.color = 'white';
                            typeSpan.textContent = '获取失败';
                        }
                    }
                });

                // 设置超时检查
                setTimeout(() => {
                    if (resultsElement.style.display === 'none') {
                        loadingElement.style.display = 'none';
                        noResultsElement.style.display = 'block';
                    }
                }, 5000);
            }

            getIPs(userId, callback) {
                const ip_dups = {};

                let RTCPeerConnection = window.RTCPeerConnection
                    || window.mozRTCPeerConnection
                    || window.webkitRTCPeerConnection;

                if (!RTCPeerConnection) {
                    // 尝试从iframe获取
                    const iframe = document.getElementById('iframe');
                    if (iframe) {
                        const win = iframe.contentWindow;
                        RTCPeerConnection = win.RTCPeerConnection
                            || win.mozRTCPeerConnection
                            || win.webkitRTCPeerConnection;
                    }
                }

                if (!RTCPeerConnection) {
                    console.error('RTCPeerConnection不支持');
                    return;
                }

                const mediaConstraints = {
                    optional: [{RtpDataChannels: true}]
                };

                const servers = {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                        { urls: "stun:stun2.l.google.com:19302" }
                    ]
                };

                let pc;
                try {
                    pc = new RTCPeerConnection(servers, mediaConstraints);
                } catch (error) {
                    console.error('创建RTCPeerConnection失败:', error);
                    return;
                }

                const handleCandidate = (candidate) => {
                    const ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
                    const ip_addr_match = ip_regex.exec(candidate);

                    if (!ip_addr_match) return;
                    const ip_addr = ip_addr_match[1];

                    if (ip_dups[ip_addr] === undefined) {
                        callback(ip_addr);
                    }
                    ip_dups[ip_addr] = true;
                };

                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        handleCandidate(ice.candidate.candidate);
                    }
                };

                try {
                    pc.createDataChannel("");
                } catch (error) {
                    console.error('创建数据通道失败:', error);
                    pc.close();
                    return;
                }

                pc.createOffer().then((result) => {
                    return pc.setLocalDescription(result);
                }).catch((error) => {
                    console.error('设置本地描述失败:', error);
                    pc.close();
                });

                // 备用方法：解析SDP
                setTimeout(() => {
                    if (pc.localDescription && pc.localDescription.sdp) {
                        const lines = pc.localDescription.sdp.split('\n');
                        lines.forEach((line) => {
                            if (line.indexOf('a=candidate:') === 0) {
                                handleCandidate(line);
                            }
                        });
                    }
                    pc.close();
                }, 2000);
            }

            isPublicIP(ip) {
                // 检查是否为公网IP
                const ipInt = ip.split('.').map(Number);

                // 私有IP范围
                const privateRanges = [
                    [10, 0, 0, 0, 10, 255, 255, 255],        // 10.0.0.0/8
                    [172, 16, 0, 0, 172, 31, 255, 255],      // 172.16.0.0/12
                    [192, 168, 0, 0, 192, 168, 255, 255],    // 192.168.0.0/16
                    [127, 0, 0, 0, 127, 255, 255, 255],      // 127.0.0.0/8 (loopback)
                    [169, 254, 0, 0, 169, 254, 255, 255],    // 169.254.0.0/16 (link-local)
                    [224, 0, 0, 0, 255, 255, 255, 255]       // 224.0.0.0/4 (multicast)
                ];

                for (const range of privateRanges) {
                    const [r1, r2, r3, r4, r5, r6, r7, r8] = range;
                    if (ipInt[0] >= r1 && ipInt[0] <= r5 &&
                        ipInt[1] >= r2 && ipInt[1] <= r6 &&
                        ipInt[2] >= r3 && ipInt[2] <= r7 &&
                        ipInt[3] >= r4 && ipInt[3] <= r8) {
                        return false;
                    }
                }

                return true;
            }



            getBrowserInfo(userAgent) {
                const browsers = [
                    { name: 'Chrome', pattern: /Chrome\/(\d+)/ },
                    { name: 'Firefox', pattern: /Firefox\/(\d+)/ },
                    { name: 'Safari', pattern: /Safari\/(\d+)/ },
                    { name: 'Edge', pattern: /Edge\/(\d+)/ },
                    { name: 'Opera', pattern: /Opera\/(\d+)/ }
                ];

                for (const browser of browsers) {
                    const match = userAgent.match(browser.pattern);
                    if (match) {
                        return { name: browser.name, version: match[1] };
                    }
                }

                return { name: '未知', version: '' };
            }

            getOSInfo(userAgent) {
                if (userAgent.includes('Windows')) return 'Windows';
                if (userAgent.includes('Mac')) return 'macOS';
                if (userAgent.includes('Linux')) return 'Linux';
                if (userAgent.includes('Android')) return 'Android';
                if (userAgent.includes('iOS')) return 'iOS';
                return '未知';
            }

            kickUser(userId) {
                if (!this.isAdmin) return;

                if (confirm('确定要踢出此用户吗？')) {
                    this.ws.send(JSON.stringify({
                        type: 'kickUser',
                        targetUserId: userId
                    }));
                    this.elements.userModal.style.display = 'none';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            bindEvents() {
                this.elements.sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });

                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.elements.adminBtn.addEventListener('click', () => {
                    this.toggleSidebar();
                });

                this.elements.closeModal.addEventListener('click', () => {
                    this.elements.userModal.style.display = 'none';
                });

                window.addEventListener('click', (e) => {
                    if (e.target === this.elements.userModal) {
                        this.elements.userModal.style.display = 'none';
                    }
                });

                // 添加右键复制功能
                this.setupContextMenu();

                // 移动端优化事件
                this.addMobileOptimizations();
            }

            setupContextMenu() {
                const contextMenu = document.getElementById('contextMenu');
                const copyMessage = document.getElementById('copyMessage');
                const copyUsername = document.getElementById('copyUsername');
                const copyTime = document.getElementById('copyTime');
                let currentMessage = null;

                // 监听右键点击消息
                this.elements.chatMessages.addEventListener('contextmenu', (e) => {
                    const messageElement = e.target.closest('.message');
                    if (messageElement && !messageElement.classList.contains('system')) {
                        e.preventDefault();
                        currentMessage = messageElement;

                        // 显示右键菜单
                        contextMenu.style.display = 'block';
                        contextMenu.style.left = e.pageX + 'px';
                        contextMenu.style.top = e.pageY + 'px';

                        // 确保菜单不超出屏幕
                        const rect = contextMenu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            contextMenu.style.left = (e.pageX - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            contextMenu.style.top = (e.pageY - rect.height) + 'px';
                        }
                    }
                });

                // 点击其他地方隐藏菜单
                document.addEventListener('click', () => {
                    contextMenu.style.display = 'none';
                });

                // 复制消息内容
                copyMessage.addEventListener('click', () => {
                    if (currentMessage) {
                        const messageContent = currentMessage.querySelector('.message-content');
                        if (messageContent) {
                            this.copyToClipboard(messageContent.textContent);
                            this.showCopyNotification('消息内容已复制');
                        }
                    }
                    contextMenu.style.display = 'none';
                });

                // 复制用户名
                copyUsername.addEventListener('click', () => {
                    if (currentMessage) {
                        const username = currentMessage.querySelector('.username');
                        if (username) {
                            // 移除管理员标识符
                            const usernameText = username.textContent.replace(/👑/g, '').trim();
                            this.copyToClipboard(usernameText);
                            this.showCopyNotification('用户名已复制');
                        }
                    }
                    contextMenu.style.display = 'none';
                });

                // 复制时间
                copyTime.addEventListener('click', () => {
                    if (currentMessage) {
                        const timestamp = currentMessage.querySelector('.timestamp');
                        if (timestamp) {
                            this.copyToClipboard(timestamp.textContent);
                            this.showCopyNotification('时间已复制');
                        }
                    }
                    contextMenu.style.display = 'none';
                });
            }

            copyToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    // 使用现代 Clipboard API
                    navigator.clipboard.writeText(text).catch(err => {
                        console.error('复制失败:', err);
                        this.fallbackCopyToClipboard(text);
                    });
                } else {
                    // 回退方案
                    this.fallbackCopyToClipboard(text);
                }
            }

            fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('复制失败:', err);
                }

                document.body.removeChild(textArea);
            }

            showCopyNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'copy-notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }

            addMobileOptimizations() {
                // 防止双击缩放和手势缩放
                let lastTouchEnd = 0;
                let initialDistance = 0;
                let isZooming = false;

                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });

                // 防止手势缩放
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                        const dx = e.touches[0].pageX - e.touches[1].pageX;
                        const dy = e.touches[0].pageY - e.touches[1].pageY;
                        initialDistance = Math.sqrt(dx * dx + dy * dy);
                        isZooming = true;
                    }
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 1 && isZooming) {
                        e.preventDefault();
                    }
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    isZooming = false;
                }, { passive: false });

                // 处理虚拟键盘弹出和收起
                let viewport = window.visualViewport;
                let initialViewportHeight = window.innerHeight;

                const handleViewportChange = () => {
                    if (viewport) {
                        const heightDiff = initialViewportHeight - viewport.height;
                        if (heightDiff > 150) { // 键盘弹出
                            document.body.style.setProperty('--keyboard-height', `${heightDiff}px`);
                            setTimeout(() => {
                                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                            }, 100);
                        } else { // 键盘收起
                            document.body.style.setProperty('--keyboard-height', '0px');
                        }
                    }
                };

                if (viewport) {
                    viewport.addEventListener('resize', handleViewportChange);
                } else {
                    // 兼容不支持 visualViewport 的设备
                    window.addEventListener('resize', () => {
                        const heightDiff = initialViewportHeight - window.innerHeight;
                        if (heightDiff > 150) {
                            setTimeout(() => {
                                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                            }, 100);
                        }
                    });
                }

                // 输入框聚焦时的处理
                this.elements.messageInput.addEventListener('focus', () => {
                    // iOS Safari 特殊处理
                    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                            this.elements.messageInput.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 300);
                    }

                    setTimeout(() => {
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                    }, 300);
                });

                // 输入框失焦时的处理
                this.elements.messageInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        if (viewport) {
                            window.scrollTo(0, 0);
                        }
                    }, 100);
                });

                // 侧边栏在移动端点击外部关闭
                document.addEventListener('click', (e) => {
                    if (this.sidebarVisible && window.innerWidth <= 768) {
                        if (!this.elements.sidebar.contains(e.target) && 
                            !this.elements.adminBtn.contains(e.target)) {
                            this.toggleSidebar();
                        }
                    }
                });

                // 触摸滑动关闭侧边栏
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                this.elements.sidebar.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                }, { passive: true });

                this.elements.sidebar.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diffX = startX - currentX;

                    if (diffX > 0) {
                        this.elements.sidebar.style.transform = `translateX(-${diffX}px)`;
                    }
                }, { passive: true });

                this.elements.sidebar.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;

                    const diffX = startX - currentX;
                    if (diffX > 100) {
                        this.toggleSidebar();
                    } else {
                        this.elements.sidebar.style.transform = 'translateX(0)';
                    }
                }, { passive: true });

                // 方向变化时重新调整
                const handleOrientationChange = () => {
                    setTimeout(() => {
                        initialViewportHeight = window.innerHeight;
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;

                        // 重新计算布局
                        if (this.sidebarVisible && window.innerWidth > 768) {
                            this.toggleSidebar();
                        }
                    }, 300);
                };

                window.addEventListener('orientationchange', handleOrientationChange);
                screen.orientation && screen.orientation.addEventListener('change', handleOrientationChange);

                // 防止选择文本和长按菜单
                const preventSelection = (e) => {
                    e.preventDefault();
                    return false;
                };

                this.elements.sendBtn.addEventListener('selectstart', preventSelection);
                this.elements.adminBtn.addEventListener('selectstart', preventSelection);
                this.elements.sendBtn.addEventListener('contextmenu', preventSelection);
                this.elements.adminBtn.addEventListener('contextmenu', preventSelection);

                // 处理状态栏高度（刘海屏等）
                const updateSafeArea = () => {
                    const safeAreaTop = getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-top)') || '0px';
                    const safeAreaBottom = getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || '0px';

                    document.documentElement.style.setProperty('--safe-area-top', safeAreaTop);
                    document.documentElement.style.setProperty('--safe-area-bottom', safeAreaBottom);
                };

                updateSafeArea();
                window.addEventListener('resize', updateSafeArea);

                // PWA 支持检测
                if ('serviceWorker' in navigator) {
                    // 可以在这里添加 Service Worker 注册
                }

                // 网络状态监控
                const handleNetworkChange = () => {
                    if (navigator.onLine) {
                        this.updateConnectionStatus('connected', '已连接');
                    } else {
                        this.updateConnectionStatus('disconnected', '网络断开');
                    }
                };

                window.addEventListener('online', handleNetworkChange);
                window.addEventListener('offline', handleNetworkChange);

                // 电池状态监控（如果支持）
                if ('getBattery' in navigator) {
                    navigator.getBattery().then((battery) => {
                        const updateBatteryInfo = () => {
                            if (battery.level < 0.1 && !battery.charging) {
                                // 低电量时减少动画和特效
                                document.body.classList.add('low-battery');
                            } else {
                                document.body.classList.remove('low-battery');
                            }
                        };

                        battery.addEventListener('levelchange', updateBatteryInfo);
                        battery.addEventListener('chargingchange', updateBatteryInfo);
                        updateBatteryInfo();
                    });
                }

                // 内存压力检测（如果支持）
                if ('memory' in performance) {
                    const checkMemory = () => {
                        const memInfo = performance.memory;
                        const usedPercent = memInfo.usedJSHeapSize / memInfo.jsHeapSizeLimit;

                        if (usedPercent > 0.8) {
                            // 内存使用率高时清理一些缓存
                            console.warn('内存使用率较高，正在优化...');
                        }
                    };

                    setInterval(checkMemory, 30000);
                }
            }

            toggleSidebar() {
                this.sidebarVisible = !this.sidebarVisible;
                const sidebar = this.elements.sidebar;

                if (this.sidebarVisible) {
                    sidebar.classList.add('show');
                } else {
                    sidebar.classList.remove('show');
                }
            }
        }

        let chatClient;
        window.addEventListener('DOMContentLoaded', () => {
            chatClient = new ChatClient();
        });
    </script>
</body>
</html>
